<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kampus VPN</title>
    <link id="favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%234a5568'/%3E%3Cpath d='M16 6l-7 3v5c0 4.4 3 8.5 7 9.5 4-1 7-5.1 7-9.5V9l-7-3zm0 8h5.5c-.4 3.3-2.6 6.2-5.5 7.1V14h-5.5V9.5l5.5-2.5v7z' fill='white'/%3E%3C/svg%3E">
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-primary: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --bg-secondary: rgba(15,12,41,0.95);
            --bg-modal: rgba(26, 31, 50, 0.98);
            --text-primary: #fff;
            --text-secondary: #8892b0;
            --text-muted: #4a5568;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --border-color: rgba(255,255,255,0.1);
            --card-bg: rgba(0,0,0,0.2);
            --button-bg: linear-gradient(145deg, #252d45, #1a1f32);
        }
        
        [data-theme="light"] {
            --bg-primary: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 50%, #e8eaf6 100%);
            --bg-secondary: rgba(255,255,255,0.95);
            --bg-modal: rgba(255,255,255,0.98);
            --text-primary: #1a1a2e;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: rgba(0,0,0,0.1);
            --card-bg: rgba(0,0,0,0.05);
            --button-bg: linear-gradient(145deg, #f0f0f0, #e0e0e0);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        
        /* Animated background */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        /* Animated particles background */
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 130px 80px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 160px 120px, rgba(255,255,255,0.4), transparent);
            background-size: 200px 200px;
            animation: particleMove 20s linear infinite;
            pointer-events: none;
            opacity: 0.5;
        }
        
        @keyframes particleMove {
            0% { background-position: 0 0; }
            100% { background-position: 200px 200px; }
        }
        
        .container { text-align: center; padding: 15px; padding-bottom: 55px; position: relative; z-index: 1; }
        
        /* Enhanced logo with glow */
        .logo {
            width: 70px; height: 70px; margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border-radius: 18px; display: flex; align-items: center; justify-content: center;
            margin-left: auto; margin-right: auto;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4), 0 0 60px rgba(118, 75, 162, 0.2);
            animation: logoFloat 3s ease-in-out infinite;
            position: relative;
        }
        .logo::after {
            content: '';
            position: absolute;
            top: -3px; left: -3px; right: -3px; bottom: -3px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb, #667eea);
            border-radius: 20px;
            z-index: -1;
            filter: blur(10px);
            opacity: 0.5;
            animation: logoGlow 3s ease-in-out infinite alternate;
        }
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes logoGlow {
            0% { opacity: 0.3; }
            100% { opacity: 0.6; }
        }
        .logo svg { width: 40px; height: 40px; fill: white; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        
        h1 { 
            font-size: 22px; font-weight: 700; margin-bottom: 6px; 
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle { font-size: 12px; color: #8892b0; margin-bottom: 12px; letter-spacing: 0.5px; }

        /* Badges container */
        .badges { display: flex; flex-direction: column; gap: 6px; align-items: center; margin-bottom: 12px; }
        .badge {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(102, 126, 234, 0.15); 
            border: 1px solid rgba(102, 126, 234, 0.3);
            backdrop-filter: blur(10px);
            padding: 6px 12px; border-radius: 20px; font-size: 11px; color: #a5b4fc;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
        }
        .badge:hover { 
            background: rgba(102, 126, 234, 0.25); 
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        .badge.no-sub { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        .badge.no-sub:hover { background: rgba(239, 68, 68, 0.2); box-shadow: 0 5px 20px rgba(239, 68, 68, 0.2); }
        .badge.wg-badge { background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3); color: #86efac; }
        .badge.wg-badge:hover { background: rgba(34, 197, 94, 0.2); box-shadow: 0 5px 20px rgba(34, 197, 94, 0.2); }
        .badge.wg-badge.no-wg { background: rgba(100, 100, 100, 0.1); border-color: rgba(100, 100, 100, 0.3); color: #9ca3af; }
        .badge .count { background: rgba(34, 197, 94, 0.2); padding: 2px 6px; border-radius: 10px; color: #86efac; }
        .badge.disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

        /* Tooltip */
        .tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: #fff; padding: 6px 10px; border-radius: 6px;
            font-size: 10px; white-space: nowrap; opacity: 0; pointer-events: none;
            transition: opacity 0.2s; margin-bottom: 5px;
        }
        .badge.disabled:hover .tooltip { opacity: 1; }

        /* Enhanced Power Button */
        .power-button {
            width: 120px; height: 120px; border-radius: 50%; border: none; cursor: pointer;
            background: linear-gradient(145deg, #252d45, #1a1f32);
            box-shadow: 
                12px 12px 30px rgba(0,0,0,0.5), 
                -8px -8px 25px rgba(255,255,255,0.03),
                inset 0 0 0 3px rgba(255,255,255,0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 15px;
            position: relative;
            overflow: hidden;
        }
        .power-button::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(102,126,234,0.1) 0%, transparent 70%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s;
        }
        .power-button:hover::before { transform: translate(-50%, -50%) scale(1.5); }
        .power-button:hover { transform: scale(1.05); }
        .power-button:active { transform: scale(0.95); }
        .power-button.active {
            background: linear-gradient(145deg, #1a4d2e, #0d2818);
            box-shadow: 
                12px 12px 30px rgba(0,0,0,0.5), 
                -8px -8px 25px rgba(255,255,255,0.03),
                inset 0 0 0 3px rgba(34,197,94,0.4), 
                0 0 50px rgba(34,197,94,0.3),
                0 0 100px rgba(34,197,94,0.1);
        }
        .power-button.active::before {
            background: radial-gradient(circle, rgba(34,197,94,0.2) 0%, transparent 70%);
            transform: translate(-50%, -50%) scale(1.5);
            animation: pulseGlow 2s ease-in-out infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .power-button svg { 
            width: 50px; height: 50px; stroke: #4a5568; stroke-width: 2; fill: none; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; z-index: 1;
        }
        .power-button.active svg { 
            stroke: #22c55e; 
            filter: drop-shadow(0 0 15px rgba(34,197,94,0.6)); 
        }
        .power-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }

        .status { font-size: 15px; font-weight: 500; margin-bottom: 6px; min-height: 22px; transition: all 0.3s; }
        .status.connected { color: #22c55e; text-shadow: 0 0 20px rgba(34,197,94,0.5); }
        .status.disconnected { color: #8892b0; }
        .status.connecting { color: #f59e0b; text-shadow: 0 0 20px rgba(245,158,11,0.5); }

        .error { 
            background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); 
            color: #ef4444; padding: 10px 15px; border-radius: 8px; font-size: 12px; 
            margin-top: 12px; max-width: 280px; user-select: text; cursor: text;
            backdrop-filter: blur(10px);
        }

        .footer { 
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; gap: 8px; justify-content: center; align-items: center;
            background: rgba(15,12,41,0.95); backdrop-filter: blur(10px);
            padding: 10px 12px; 
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .footer-btn { 
            background: none; border: none; color: #6b7280; font-size: 10px; cursor: pointer; 
            padding: 6px 10px; border-radius: 15px; transition: all 0.3s;
            min-width: auto; text-align: center;
        }
        .footer-btn:hover { color: #a5b4fc; background: rgba(102,126,234,0.15); }
        .footer-btn.disabled { opacity: 0.4; cursor: not-allowed; }
        .footer-btn.disabled:hover { color: #6b7280; background: none; }
        
        /* Version badge - oval pill above footer */
        .version-badge {
            position: fixed;
            bottom: 52px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 27, 60, 0.85);
            border: 1px solid rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(10px);
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 10px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            color: rgba(139, 92, 246, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            z-index: 100;
        }
        .version-badge:hover {
            border-color: rgba(139, 92, 246, 0.6);
            color: rgba(167, 139, 250, 0.9);
            background: rgba(40, 35, 75, 0.9);
        }

        /* Servers Panel - Glass morphism */
        .servers-panel {
            background: rgba(100,255,218,0.03); 
            border: 1px solid rgba(100,255,218,0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px; padding: 10px; margin: 12px 0; max-width: 100%;
        }
        .servers-panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(100,255,218,0.1);
        }
        .servers-panel-title { font-size: 10px; color: #8892b0; text-transform: uppercase; letter-spacing: 1px; }
        .servers-list { display: flex; flex-direction: column; gap: 4px; }
        .server-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 10px; background: rgba(0,0,0,0.2); border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 2px solid transparent;
        }
        .server-item:hover { background: rgba(0,0,0,0.3); transform: translateX(3px); }
        .server-item.active { 
            background: rgba(100,255,218,0.1); 
            border-left-color: #64ffda; 
            box-shadow: 0 0 20px rgba(100,255,218,0.1);
        }
        .server-item.internal { background: rgba(102,126,234,0.08); border-left-color: rgba(102,126,234,0.5); }
        .server-item.internal.active { background: rgba(102,126,234,0.15); border-left-color: #667eea; }
        .server-name { font-size: 11px; color: #ccd6f6; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .server-ping { font-size: 10px; font-weight: 600; min-width: 50px; text-align: right; }
        .server-ping.good { color: #64ffda; }
        .server-ping.medium { color: #ffd93d; }
        .server-ping.bad { color: #ff6b6b; }
        .server-ping.timeout { color: #4a5568; }
        .server-ping.ping-active { color: #667eea; }
        .server-ping.ping-timeout { color: #4a5568; }
        .server-ping.loading { color: #8892b0; animation: pulse 1s infinite; }
        .show-all-btn {
            width: 100%; margin-top: 6px; background: rgba(100,255,218,0.05);
            border: 1px dashed rgba(100,255,218,0.2); color: #64ffda;
            padding: 6px; border-radius: 8px; font-size: 10px; cursor: pointer;
            transition: all 0.3s;
        }
        .show-all-btn:hover { 
            background: rgba(100,255,218,0.1); 
            border-style: solid; 
            transform: translateY(-2px);
        }

        /* Servers Modal */
        .servers-modal { max-height: 80vh; }
        .servers-modal .modal { width: 380px; max-width: 95%; }
        .servers-modal-list {
            max-height: 350px; overflow-y: auto; margin: 12px 0;
            background: rgba(0,0,0,0.2); border-radius: 10px; padding: 8px;
        }
        .servers-modal-list .server-item { margin-bottom: 4px; }
        .servers-modal-list .server-item:last-child { margin-bottom: 0; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .connecting .status { animation: pulse 1.5s infinite; }

        /* Modal - Glass morphism */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: linear-gradient(135deg, rgba(30,39,68,0.95) 0%, rgba(22,29,48,0.95) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px; padding: 22px; width: 374px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.6), 0 0 1px rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.08);
            animation: modalIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Custom Scrollbar */
        .modal::-webkit-scrollbar { width: 6px; }
        .modal::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
        .modal::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.4); border-radius: 3px; }
        .modal::-webkit-scrollbar-thumb:hover { background: rgba(102,126,234,0.6); }
        
        /* Global custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(102,126,234,0.5); }
        @keyframes modalIn {
            from { transform: scale(0.9) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .modal h2 { font-size: 18px; margin-bottom: 8px; color: #fff; }
        .modal p { font-size: 12px; color: #8892b0; margin-bottom: 16px; }
        .modal input, .modal textarea {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3);
            color: #fff; font-size: 13px; outline: none; transition: border-color 0.2s;
        }
        .modal input:focus, .modal textarea:focus { border-color: rgba(102,126,234,0.5); }
        .modal input::placeholder, .modal textarea::placeholder { color: #4a5568; }
        .modal textarea { min-height: 120px; resize: vertical; font-family: monospace; }
        .modal label { display: block; font-size: 11px; color: #8892b0; margin-bottom: 4px; margin-top: 12px; }
        .modal label:first-of-type { margin-top: 0; }
        
        /* Input wrapper with paste button */
        .input-wrapper {
            position: relative;
            width: 100%;
        }
        .input-wrapper input, .input-wrapper textarea {
            padding-right: 40px;
        }
        .paste-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            color: #a5b4fc;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .paste-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }
        .paste-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        .paste-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }
        .input-wrapper.textarea-wrapper .paste-btn {
            top: 12px;
            transform: none;
        }
        .input-wrapper.textarea-wrapper .paste-btn:active {
            transform: scale(0.95);
        }
        
        /* Context menu */
        .context-menu {
            position: fixed;
            background: rgba(30, 39, 68, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            min-width: 120px;
            display: none;
        }
        .context-menu.active { display: block; }
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            color: #ccd6f6;
            font-size: 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .context-menu-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        .context-menu-item svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
            opacity: 0.7;
        }
        
        .modal-buttons { display: flex; gap: 10px; margin-top: 16px; }
        .modal-btn {
            flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer;
            font-size: 13px; font-weight: 500; transition: all 0.2s;
        }
        .modal-btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .modal-btn.primary:hover { opacity: 0.9; }
        .modal-btn.primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-btn.secondary { background: rgba(255,255,255,0.1); color: #8892b0; }
        .modal-btn.secondary:hover { background: rgba(255,255,255,0.15); }
        .modal-btn.danger { background: rgba(239,68,68,0.2); color: #ef4444; }
        .modal-btn.danger:hover { background: rgba(239,68,68,0.3); }
        .modal-status { margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 12px; display: none; user-select: text; cursor: text; }
        .modal-status.success { display: block; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); color: #86efac; }
        .modal-status.error { display: block; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #fca5a5; }
        .modal-status.loading { display: block; background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); color: #fcd34d; }

        .proxy-list, .wg-list {
            max-height: 150px; overflow-y: auto; margin-top: 10px; padding: 8px;
            background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 11px;
        }
        .proxy-item, .wg-item {
            padding: 6px 8px; display: flex; justify-content: space-between; align-items: center;
            color: #8892b0; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }
        .proxy-item:last-child, .wg-item:last-child { border-bottom: none; }
        .proxy-item:hover, .wg-item:hover { background: rgba(255,255,255,0.05); }
        .proxy-item .type, .wg-item .tag { color: #a5b4fc; font-weight: 500; text-transform: uppercase; font-size: 10px; }
        .wg-item .actions { display: flex; gap: 6px; }
        .wg-item .actions button {
            background: none; border: none; cursor: pointer; padding: 2px 6px;
            border-radius: 4px; font-size: 10px; transition: all 0.2s;
        }
        .wg-item .actions .edit { color: #a5b4fc; }
        .wg-item .actions .edit:hover { background: rgba(165,180,252,0.2); }
        .wg-item .actions .delete { color: #fca5a5; }
        .wg-item .actions .delete:hover { background: rgba(252,165,165,0.2); }
        .wg-item-info { flex: 1; min-width: 0; }
        .wg-item-header { display: flex; align-items: center; margin-bottom: 2px; }
        .wg-item-networks { font-size: 9px; color: #4a5568; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .current-sub { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 11px; word-break: break-all; }
        .current-sub .label { color: #4a5568; margin-bottom: 4px; }
        .current-sub .url { color: #8892b0; }

        /* Profile Modal Styles */
        .profiles-list {
            max-height: 300px; overflow-y: auto; margin: 12px 0;
        }
        .profile-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; margin-bottom: 8px; border-radius: 10px;
            background: rgba(255,255,255,0.05); border: 1px solid transparent;
            cursor: pointer; transition: all 0.3s;
        }
        .profile-item:hover { background: rgba(102,126,234,0.1); }
        .profile-item.active { 
            background: rgba(102,126,234,0.15); 
            border-color: rgba(102,126,234,0.4);
            box-shadow: 0 0 20px rgba(102,126,234,0.2);
        }
        .profile-item .profile-info { flex: 1; }
        .profile-item .profile-name { 
            font-weight: 600; color: #fff; font-size: 14px; 
            display: flex; align-items: center; gap: 8px;
        }
        .profile-item .profile-name .default-badge {
            font-size: 9px; background: rgba(102,126,234,0.3); 
            padding: 2px 6px; border-radius: 8px; color: #a5b4fc;
        }
        .profile-item .profile-meta { 
            font-size: 11px; color: #6b7280; margin-top: 4px;
            display: flex; gap: 12px;
        }
        .profile-item .profile-meta span { display: flex; align-items: center; gap: 4px; }
        .profile-item .profile-actions { display: flex; gap: 6px; }
        .profile-item .profile-actions button {
            background: none; border: none; cursor: pointer;
            padding: 6px 8px; border-radius: 6px; font-size: 12px;
            transition: all 0.2s; opacity: 0.6;
        }
        .profile-item:hover .profile-actions button { opacity: 1; }
        .profile-item .profile-actions .edit-btn { color: #a5b4fc; }
        .profile-item .profile-actions .edit-btn:hover { background: rgba(165,180,252,0.2); }
        .profile-item .profile-actions .delete-btn { color: #fca5a5; }
        .profile-item .profile-actions .delete-btn:hover { background: rgba(252,165,165,0.2); }
        .profile-item .profile-actions .delete-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .profile-item .active-indicator {
            width: 8px; height: 8px; border-radius: 50%; margin-right: 10px;
            background: #22c55e; box-shadow: 0 0 10px rgba(34,197,94,0.5);
        }
        .add-profile-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 12px; margin-top: 8px;
            background: rgba(255,255,255,0.05); border: 1px dashed rgba(255,255,255,0.2);
            border-radius: 10px; color: #8892b0; font-size: 13px;
            cursor: pointer; transition: all 0.3s;
        }
        .add-profile-btn:hover { 
            background: rgba(102,126,234,0.1); 
            border-color: rgba(102,126,234,0.4);
            color: #a5b4fc;
        }

        /* Logo clickable styles */
        .logo { cursor: pointer; }
        .logo:hover { transform: scale(1.05); }
        .logo.clickable::after { opacity: 0.7; }

        /* About modal - Enhanced */
        .about-content { text-align: center; }
        .about-logo { 
            width: 60px; height: 60px; margin: 0 auto 14px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); 
            border-radius: 16px; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 8px 30px rgba(102,126,234,0.4);
            animation: aboutLogoFloat 3s ease-in-out infinite;
        }
        @keyframes aboutLogoFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(2deg); }
        }
        .about-logo svg { width: 35px; height: 35px; fill: white; }
        .about-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .about-version { font-size: 11px; color: #8892b0; margin-bottom: 16px; }
        .about-info { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 14px; margin-bottom: 14px; }
        .about-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 11px; }
        .about-row:last-child { border-bottom: none; }
        .about-row .label { color: #6b7280; }
        .about-row .value { color: #a5b4fc; }
        .about-row .value a { color: #a5b4fc; text-decoration: none; transition: color 0.2s; }
        .about-row .value a:hover { color: #c4b5fd; text-decoration: underline; }
        .about-copyright { font-size: 10px; color: #4a5568; margin-top: 10px; }

        .empty-state { text-align: center; padding: 20px; color: #4a5568; font-size: 12px; }

        /* Settings Modal */
        .settings-group { margin-bottom: 16px; }
        .settings-group-title { font-size: 11px; color: #4a5568; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 6px;
        }
        .setting-item .label { font-size: 12px; color: #d1d5db; }
        .setting-item .desc { font-size: 10px; color: #6b7280; margin-top: 2px; }
        .toggle-switch {
            position: relative; width: 44px; height: 24px; cursor: pointer;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-switch .slider {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(100,100,100,0.5); border-radius: 24px; transition: 0.3s;
        }
        .toggle-switch .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;
        }
        .toggle-switch input:checked + .slider { background: #22c55e; }
        .toggle-switch input:checked + .slider:before { transform: translateX(20px); }

        /* Settings Select */
        .setting-select {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 6px 10px; color: #fff; font-size: 12px;
            cursor: pointer; outline: none; min-width: 100px;
        }
        .setting-select:focus { border-color: rgba(102,126,234,0.5); }
        .setting-select option { background: #1a1f32; color: #fff; }

        /* Stats Modal - Enhanced */
        .stats-charts { margin-bottom: 16px; }
        .chart-container { 
            background: rgba(0,0,0,0.2); border-radius: 12px; padding: 12px; 
            margin-bottom: 10px; overflow: hidden;
        }
        .chart-title { 
            font-size: 10px; color: #6b7280; margin-bottom: 8px; 
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .chart-container canvas { display: block; width: 100%; height: auto; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
        .stat-card {
            background: rgba(0,0,0,0.2); border-radius: 14px; padding: 12px; text-align: center;
            transition: all 0.3s; position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            opacity: 0.3;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card .icon { font-size: 20px; margin-bottom: 6px; }
        .stat-card .value { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .stat-card .label { font-size: 9px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card.upload { color: #22c55e; }
        .stat-card.upload .value { color: #22c55e; }
        .stat-card.download { color: #3b82f6; }
        .stat-card.download .value { color: #3b82f6; }
        .stat-card.duration { color: #f59e0b; }
        .stat-card.duration .value { color: #f59e0b; }
        .stat-card.sessions { color: #a855f7; }
        .stat-card.sessions .value { color: #a855f7; }
        .stats-section { margin-top: 14px; }
        .stats-section-title { font-size: 10px; color: #4a5568; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Logs Modal */
        .logs-modal {
            width: 90% !important; height: 90vh; max-height: 90vh; display: flex; flex-direction: column;
        }
        .logs-container {
            background: rgba(0,0,0,0.4); border-radius: 8px; padding: 12px;
            flex: 1; overflow-y: auto; font-family: 'Consolas', monospace;
            font-size: 11px; line-height: 1.6; min-height: 0;
            user-select: text; -webkit-user-select: text; cursor: text;
        }
        .log-entry { color: #9ca3af; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.03); user-select: text; }
        .log-entry:last-child { border-bottom: none; }
        .log-entry .time { color: #6b7280; margin-right: 8px; }
        .log-entry.error { color: #f87171; }
        .log-entry.success { color: #4ade80; }
        .logs-empty { text-align: center; color: #4a5568; padding: 40px 0; }

        /* Update Banner */
        .update-banner {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px 20px; border-radius: 20px; display: none; align-items: center; gap: 12px;
            box-shadow: 0 4px 20px rgba(102,126,234,0.4); z-index: 100; animation: slideDown 0.3s ease;
        }
        .update-banner.show { display: flex; }
        .update-banner .text { font-size: 12px; color: #fff; }
        .update-banner .btn {
            background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 4px 12px;
            border-radius: 12px; cursor: pointer; font-size: 11px; transition: 0.2s;
        }
        .update-banner .btn:hover { background: rgba(255,255,255,0.3); }
        .update-banner .close {
            background: none; border: none; color: rgba(255,255,255,0.7); cursor: pointer;
            font-size: 16px; padding: 0 4px; line-height: 1;
        }
        @keyframes slideDown { from { transform: translateX(-50%) translateY(-100%); } to { transform: translateX(-50%) translateY(0); } }

        /* Toast Notifications */
        .toast-container {
            position: fixed; bottom: 50px; right: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 8px;
        }
        .toast {
            background: rgba(30,39,68,0.95); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 10px 14px;
            display: flex; align-items: flex-start; gap: 10px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.4), 0 0 1px rgba(255,255,255,0.1);
            border-left: 3px solid #667eea; animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-width: 320px;
        }
        .toast.success { border-left-color: #22c55e; }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }
        .toast .icon { font-size: 16px; flex-shrink: 0; margin-top: 2px; }
        .toast .toast-content { flex: 1; min-width: 0; }
        .toast .message { 
            font-size: 11px; color: #d1d5db; 
            user-select: text; cursor: text; 
            word-break: break-word; 
            line-height: 1.4;
        }
        .toast .toast-actions {
            display: flex; gap: 6px; margin-top: 6px;
        }
        .toast .toast-btn {
            background: rgba(255,255,255,0.1); border: none; color: #a0aec0;
            padding: 3px 8px; border-radius: 4px; font-size: 9px; cursor: pointer;
            transition: all 0.2s;
        }
        .toast .toast-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .toast .toast-btn.copied { background: #22c55e; color: #fff; }
        .toast .toast-close {
            background: none; border: none; color: #6b7280; cursor: pointer;
            font-size: 14px; padding: 0; margin-left: 4px; flex-shrink: 0;
        }
        .toast .toast-close:hover { color: #fff; }
        .toast.hide { animation: toastOut 0.3s ease forwards; }
        @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        /* QR Scanner Styles */
        .qr-scanner-container {
            position: relative; width: 100%; max-width: 300px; margin: 0 auto;
            background: #000; border-radius: 12px; overflow: hidden;
        }
        .qr-scanner-container video {
            width: 100%; height: auto; display: block;
        }
        .qr-scanner-container canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        .qr-scanner-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .qr-scanner-frame {
            width: 200px; height: 200px; border: 2px solid rgba(102,126,234,0.8);
            border-radius: 16px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            position: relative;
        }
        .qr-scanner-frame::before, .qr-scanner-frame::after {
            content: ''; position: absolute; width: 30px; height: 30px;
            border-color: #667eea; border-style: solid;
        }
        .qr-scanner-frame::before {
            top: -2px; left: -2px; border-width: 3px 0 0 3px; border-radius: 12px 0 0 0;
        }
        .qr-scanner-frame::after {
            bottom: -2px; right: -2px; border-width: 0 3px 3px 0; border-radius: 0 0 12px 0;
        }
        .qr-scanner-line {
            position: absolute; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            animation: scanLine 2s linear infinite;
        }
        @keyframes scanLine {
            0% { top: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .qr-btn-row {
            display: flex; gap: 8px; margin-top: 12px;
        }
        .qr-file-input { display: none; }
        
        /* Update Modal Styles */
        .update-progress {
            margin: 16px 0;
        }
        .update-progress-bar {
            height: 8px; background: rgba(255,255,255,0.1);
            border-radius: 4px; overflow: hidden;
        }
        .update-progress-fill {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s; width: 0%;
        }
        .update-progress-text {
            font-size: 11px; color: #8892b0; margin-top: 6px; text-align: center;
        }
        .update-info {
            background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px; margin-bottom: 12px;
        }
        .update-info-row {
            display: flex; justify-content: space-between; font-size: 12px; padding: 4px 0;
        }
        .update-info-row .label { color: #6b7280; }
        .update-info-row .value { color: #a5b4fc; }
        .update-notes {
            max-height: 150px; overflow-y: auto; font-size: 11px; color: #8892b0;
            background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;
            white-space: pre-wrap; margin-top: 12px;
        }
    </style>
</head>
<body>
    <!-- Update Banner -->
    <div class="update-banner" id="updateBanner">
        <span class="text">üöÄ –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è <span id="updateVersion"></span></span>
        <button class="btn" onclick="openUpdateModal()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="close" onclick="hideUpdateBanner()">√ó</button>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container" id="app">
        <div class="logo clickable" id="profileLogo" onclick="openProfilesModal()" title="–í—ã–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
            <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
        </div>
        <h1>Kampus VPN</h1>
        <p class="subtitle" id="activeProfileName">–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</p>
        
        <div class="badges">
            <div class="badge no-sub" id="vpnBadge" onclick="handleVpnBadgeClick()">
                <span>‚ö° –î–æ–±–∞–≤–∏—Ç—å VPN</span>
                <span class="tooltip">–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ VPN</span>
            </div>
            <div class="badge wg-badge no-wg" id="wgBadge" onclick="handleWgBadgeClick()">
                <span>üè¢ –†–∞–±–æ—á–∏–µ —Å–µ—Ç–∏: 0</span>
                <span class="tooltip">–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ VPN</span>
            </div>
        </div>
        
        <button class="power-button" id="powerBtn" onclick="toggle()">
            <svg viewBox="0 0 24 24">
                <path d="M12 3v9" stroke-linecap="round"/>
                <path d="M18.36 6.64A9 9 0 1 1 5.64 6.64" stroke-linecap="round"/>
            </svg>
        </button>
        
        <div class="status disconnected" id="status">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
        <div id="error"></div>
        
        <!-- Ping Panel (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏) -->
        <div class="servers-panel" id="serversPanel" style="display: none;">
            <div class="servers-panel-header">
                <span class="servers-panel-title">Ping</span>
            </div>
            <div class="servers-list" id="serversList">
                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <button class="show-all-btn" id="showAllServersBtn" style="display: none;" onclick="openServersModal()">
                –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ (<span id="totalServersCount">0</span>)
            </button>
        </div>
        
        <!-- Version Badge -->
        <div class="version-badge" id="versionBadge" title="Click to copy">v...</div>
        
        <div class="footer">
            <button class="footer-btn" id="settingsBtn" onclick="openSettings()" title="">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="footer-btn" onclick="openStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="footer-btn" onclick="openLogsModal()">üìã –õ–æ–≥–∏</button>
            <button class="footer-btn" onclick="openAbout()">‚ÑπÔ∏è About</button>
        </div>
    </div>

    <!-- VPN Subscription Modal -->
    <div class="modal-overlay" id="vpnModal" onclick="closeModalOnOverlay(event, 'vpnModal')">
        <div class="modal">
            <h2>üîó –î–æ–±–∞–≤–∏—Ç—å VPN</h2>
            <p>–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥</p>
            <div class="current-sub" id="currentSub" style="display: none;">
                <div class="label">–¢–µ–∫—É—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞:</div>
                <div class="url" id="currentSubUrl"></div>
            </div>
            <div class="input-wrapper">
                <input type="text" id="subscriptionInput" placeholder="https://... –∏–ª–∏ vless://..." autocomplete="off">
                <button class="paste-btn" onclick="pasteToInput('subscriptionInput')" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞">
                    <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                </button>
            </div>
            <div class="modal-status" id="vpnModalStatus"></div>
            <div class="proxy-list" id="proxyList" style="display: none;"></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('vpnModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn secondary" onclick="openQRScanner()">üì∑ QR</button>
                <button class="modal-btn danger" id="removeVpnBtn" onclick="removeSubscription()" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="modal-btn primary" id="testVpnBtn" onclick="testSubscription()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                <button class="modal-btn primary" id="saveVpnBtn" onclick="saveSubscription()" style="display: none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- WireGuard List Modal -->
    <div class="modal-overlay" id="wgListModal" onclick="closeModalOnOverlay(event, 'wgListModal')">
        <div class="modal">
            <h2>üè¢ –†–∞–±–æ—á–∏–µ —Å–µ—Ç–∏ (WireGuard)</h2>
            <p>–í—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏ –∞–∫—Ç–∏–≤–Ω—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –¢—Ä–∞—Ñ–∏–∫ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ AllowedIPs.</p>
            <div class="wg-list" id="wgList">
                <div class="empty-state">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö —Å–µ—Ç–µ–π</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('wgListModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="modal-btn primary" onclick="openAddWgModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- WireGuard Add/Edit Modal -->
    <div class="modal-overlay" id="wgEditModal" onclick="closeModalOnOverlay(event, 'wgEditModal')">
        <div class="modal">
            <h2 id="wgEditTitle">‚ûï –î–æ–±–∞–≤–∏—Ç—å WireGuard</h2>
            <p>–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π WireGuard –∫–æ–Ω—Ñ–∏–≥ –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –≤—Ä—É—á–Ω—É—é</p>
            
            <label>–¢–µ–≥ (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤) *</label>
            <div class="input-wrapper">
                <input type="text" id="wgTag" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: kampus-internal" pattern="[a-zA-Z][a-zA-Z0-9_-]*">
                <button class="paste-btn" onclick="pasteToInput('wgTag')" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞">
                    <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                </button>
            </div>
            
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <div class="input-wrapper">
                <input type="text" id="wgName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: K-AMPUS –û—Ñ–∏—Å">
                <button class="paste-btn" onclick="pasteToInput('wgName')" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞">
                    <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                </button>
            </div>
            
            <label>WireGuard –∫–æ–Ω—Ñ–∏–≥</label>
            <div class="input-wrapper textarea-wrapper">
                <textarea id="wgConfig" placeholder="[Interface]
PrivateKey = ...
Address = ...

[Peer]
PublicKey = ...
AllowedIPs = ...
Endpoint = ..."></textarea>
                <button class="paste-btn" onclick="pasteToInput('wgConfig')" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞">
                    <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                </button>
            </div>
            
            <div class="modal-status" id="wgModalStatus"></div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeWgEditModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn danger" id="deleteWgBtn" onclick="deleteWireGuard()" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="modal-btn primary" id="parseWgBtn" onclick="parseWireGuard()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                <button class="modal-btn primary" id="saveWgBtn" onclick="saveWireGuard()" style="display: none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- All Servers Modal -->
    <div class="modal-overlay servers-modal" id="serversModal" onclick="closeModalOnOverlay(event, 'serversModal')">
        <div class="modal">
            <h2>üì° Ping</h2>
            <p>–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã</p>
            <div class="servers-modal-list" id="serversModalList">
                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeModal('serversModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal-overlay" id="aboutModal" onclick="closeModalOnOverlay(event, 'aboutModal')">
        <div class="modal">
            <div class="about-content">
                <div class="about-logo">
                    <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                </div>
                <div class="about-title">Kampus VPN</div>
                <div class="about-version" id="aboutVersion">v1.0.0</div>
                <div class="about-info">
                    <div class="about-row"><span class="label">sing-box</span><span class="value" id="aboutSingboxVersion">–∑–∞–≥—Ä—É–∑–∫–∞...</span></div>
                    <div class="about-row"><span class="label">–°–±–æ—Ä–∫–∞</span><span class="value" id="aboutBuildInfo">-</span></div>
                    <div class="about-row"><span class="label">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</span><span class="value">Droponevedimka</span></div>
                    <div class="about-row"><span class="label">Email</span><span class="value"><a href="mailto:dr.oponevedimkga@gmail.com">dr.oponevedimkga@gmail.com</a></span></div>
                    <div class="about-row"><span class="label">GitHub</span><span class="value"><a href="https://github.com/Droponevedimka/k-vpn-client" target="_blank">Droponevedimka/k-vpn-client</a></span></div>
                </div>
                <div class="about-copyright">¬© 2024-2025 Kampus VPN. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</div>
                <div class="modal-buttons" style="margin-top: 16px;">
                    <button class="modal-btn secondary" onclick="closeModal('aboutModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="width: 320px;">
            <h2 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
            <p id="confirmMessage" style="margin-bottom: 20px;"></p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="confirmCancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn danger" id="confirmOk">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" onclick="closeModalOnOverlay(event, 'settingsModal')">
        <div class="modal" style="width: 360px;">
            <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
            
            <div class="settings-group">
                <div class="settings-group-title">–û–±—â–∏–µ</div>
                <div class="setting-item">
                    <div>
                        <div class="label">–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫</div>
                        <div class="desc">–ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="settingAutoStart">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                        <div class="desc">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="settingNotifications">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="label">–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ sing-box</div>
                        <div class="desc">–ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="settingEnableLogging">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="label" data-i18n="logLevel">–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                        <div class="desc" data-i18n="logLevelDesc">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ sing-box</div>
                    </div>
                    <select id="logLevelSelect" class="select-input">
                        <option value="error">Error (—Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏)</option>
                        <option value="warn" selected>Warn (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)</option>
                        <option value="info">Info (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)</option>
                        <option value="debug">Debug (–æ—Ç–ª–∞–¥–∫–∞)</option>
                        <option value="trace">Trace (—Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞)</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">–ü–æ–¥–ø–∏—Å–∫–∞</div>
                <div class="setting-item">
                    <div>
                        <div class="label">–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                        <div class="desc">–û–±–Ω–æ–≤–ª—è—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="settingAutoUpdateSub">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                <div class="setting-item">
                    <div>
                        <div class="label">–ü—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                        <div class="desc">–£–≤–µ–¥–æ–º–ª—è—Ç—å –æ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="settingCheckUpdates">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</div>
                <div class="setting-item">
                    <div>
                        <div class="label">–¢–µ–º–∞</div>
                        <div class="desc">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
                    </div>
                    <select id="settingTheme" class="setting-select">
                        <option value="dark">–¢—ë–º–Ω–∞—è</option>
                        <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
                        <option value="system">–°–∏—Å—Ç–µ–º–Ω–∞—è</option>
                    </select>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="label">–Ø–∑—ã–∫</div>
                        <div class="desc">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
                    </div>
                    <select id="settingLanguage" class="setting-select">
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</div>
                <div class="setting-item" style="flex-direction: column; align-items: stretch;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <div class="label">Template.json</div>
                            <div class="desc">–†–µ–¥–∞–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ sing-box</div>
                        </div>
                        <button class="modal-btn secondary" style="flex: 0; padding: 4px 10px; font-size: 10px;" onclick="openTemplateEditor()">üìù –†–µ–¥–∞–∫—Ç–æ—Ä</button>
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">üì¶ –ò–º–ø–æ—Ä—Ç / –≠–∫—Å–ø–æ—Ä—Ç</div>
                <div class="setting-item">
                    <div>
                        <div class="label">–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π</div>
                        <div class="desc">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ñ–∞–π–ª</div>
                    </div>
                    <button class="modal-btn secondary" style="flex: 0; padding: 4px 10px; font-size: 10px;" onclick="exportProfiles()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="label">–ò–º–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π</div>
                        <div class="desc">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –∏–∑ —Ñ–∞–π–ª–∞ (–∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ!)</div>
                    </div>
                    <button class="modal-btn secondary" style="flex: 0; padding: 4px 10px; font-size: 10px;" onclick="importProfiles()">üì• –ò–º–ø–æ—Ä—Ç</button>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="openFolder()">üìÅ –ü–∞–ø–∫–∞</button>
                <button class="modal-btn secondary" onclick="closeModal('settingsModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="modal-btn primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div class="modal-overlay" id="templateModal" onclick="closeModalOnOverlay(event, 'templateModal')">
        <div class="modal" style="width: 90%; max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
            <h2>üìù –†–µ–¥–∞–∫—Ç–æ—Ä Template</h2>
            <p>–®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ sing-box. –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è VPN.</p>
            
            <div style="flex: 1; display: flex; flex-direction: column; min-height: 0; margin: 12px 0;">
                <textarea id="templateEditor" style="flex: 1; min-height: 200px; font-family: 'Consolas', 'Monaco', monospace; font-size: 11px; line-height: 1.4; resize: none; tab-size: 2;"></textarea>
            </div>
            
            <div class="modal-status" id="templateModalStatus"></div>
            
            <div class="modal-buttons">
                <button class="modal-btn danger" onclick="resetTemplate()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="modal-btn secondary" onclick="closeModal('templateModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" onclick="saveTemplate()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="modal-overlay" id="statsModal" onclick="closeModalOnOverlay(event, 'statsModal')">
        <div class="modal" style="width: 440px;">
            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è VPN</p>
            
            <!-- Traffic Charts -->
            <div class="stats-charts">
                <div class="chart-container">
                    <div class="chart-title">–°–∫–æ—Ä–æ—Å—Ç—å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–µ–∫)</div>
                    <canvas id="speedChart" height="100"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">–¢—Ä–∞—Ñ–∏–∫ –∑–∞ —Å–µ—Å—Å–∏—é</div>
                    <canvas id="trafficChart" height="80"></canvas>
                </div>
            </div>
            
            <div class="stats-section">
                <div class="stats-section-title">–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è</div>
                <div class="stats-grid">
                    <div class="stat-card upload">
                        <div class="icon">‚Üë</div>
                        <div class="value" id="statCurrentUpload">0 B</div>
                        <div class="label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card download">
                        <div class="icon">‚Üì</div>
                        <div class="value" id="statCurrentDownload">0 B</div>
                        <div class="label">–ü–æ–ª—É—á–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card duration">
                        <div class="icon">‚è±</div>
                        <div class="value" id="statCurrentDuration">0 —Å–µ–∫</div>
                        <div class="label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                    </div>
                </div>
            </div>
            
            <div class="stats-section">
                <div class="stats-section-title">–í—Å–µ–≥–æ</div>
                <div class="stats-grid">
                    <div class="stat-card upload">
                        <div class="icon">‚Üë</div>
                        <div class="value" id="statTotalUpload">0 B</div>
                        <div class="label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card download">
                        <div class="icon">‚Üì</div>
                        <div class="value" id="statTotalDownload">0 B</div>
                        <div class="label">–ü–æ–ª—É—á–µ–Ω–æ</div>
                    </div>
                    <div class="stat-card duration">
                        <div class="icon">‚è±</div>
                        <div class="value" id="statTotalDuration">0 —Å–µ–∫</div>
                        <div class="label">–í—Ä–µ–º—è –æ–Ω–ª–∞–π–Ω</div>
                    </div>
                    <div class="stat-card sessions">
                        <div class="icon">üîÑ</div>
                        <div class="value" id="statTotalSessions">0</div>
                        <div class="label">–°–µ—Å—Å–∏–π</div>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn danger" onclick="resetStats()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button class="modal-btn secondary" onclick="closeModal('statsModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="modal-overlay" id="logsModal" onclick="closeModalOnOverlay(event, 'logsModal')">
        <div class="modal logs-modal">
            <h2>üìã –õ–æ–≥–∏</h2>
            <p>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
            
            <div class="logs-container" id="logsContainer">
                <div class="logs-empty">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="openLogs()">üìÑ –§–∞–π–ª –ª–æ–≥–æ–≤</button>
                <button class="modal-btn danger" onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="modal-btn secondary" onclick="closeModal('logsModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Profiles Modal -->
    <div class="modal-overlay" id="profilesModal" onclick="closeModalOnOverlay(event, 'profilesModal')">
        <div class="modal" style="width: 380px;">
            <h2>üë§ –ü—Ä–æ—Ñ–∏–ª–∏</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</p>
            
            <div class="profiles-list" id="profilesList">
                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            
            <button class="add-profile-btn" onclick="openCreateProfileModal()">
                ‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </button>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('profilesModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Profile Modal -->
    <div class="modal-overlay" id="profileEditModal" onclick="closeModalOnOverlay(event, 'profileEditModal')">
        <div class="modal" style="width: 340px;">
            <h2 id="profileEditTitle">‚ûï –ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <p>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</p>
            
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
            <div class="input-wrapper">
                <input type="text" id="profileNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –õ–∏—á–Ω—ã–π VPN" autocomplete="off">
                <button class="paste-btn" onclick="pasteToInput('profileNameInput')" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞">
                    <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                </button>
            </div>
            
            <div class="modal-status" id="profileModalStatus"></div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('profileEditModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn primary" id="saveProfileBtn" onclick="saveProfile()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div class="modal-overlay" id="qrScannerModal" onclick="closeModalOnOverlay(event, 'qrScannerModal')">
        <div class="modal" style="width: 360px;">
            <h2>üì∑ –°–∫–∞–Ω–µ—Ä QR-–∫–æ–¥–∞</h2>
            <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
            
            <div class="qr-scanner-container" id="qrScannerContainer">
                <video id="qrVideo" playsinline></video>
                <canvas id="qrCanvas"></canvas>
                <div class="qr-scanner-overlay">
                    <div class="qr-scanner-frame">
                        <div class="qr-scanner-line"></div>
                    </div>
                </div>
            </div>
            
            <div class="modal-status" id="qrModalStatus"></div>
            
            <div class="qr-btn-row">
                <input type="file" id="qrFileInput" class="qr-file-input" accept="image/*" onchange="scanQRFromFile(event)">
                <button class="modal-btn secondary" style="flex:1" onclick="document.getElementById('qrFileInput').click()">üìÅ –ò–∑ —Ñ–∞–π–ª–∞</button>
                <button class="modal-btn primary" style="flex:1" id="qrCameraBtn" onclick="toggleQRCamera()">üì∑ –ö–∞–º–µ—Ä–∞</button>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeQRScanner()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div class="modal-overlay" id="updateModal" onclick="closeModalOnOverlay(event, 'updateModal')">
        <div class="modal" style="width: 380px;">
            <h2>üöÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
            <p>–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è Kampus VPN</p>
            
            <div class="update-info">
                <div class="update-info-row">
                    <span class="label">–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:</span>
                    <span class="value" id="updateCurrentVersion">-</span>
                </div>
                <div class="update-info-row">
                    <span class="label">–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:</span>
                    <span class="value" id="updateNewVersion">-</span>
                </div>
                <div class="update-info-row">
                    <span class="label">–†–∞–∑–º–µ—Ä:</span>
                    <span class="value" id="updateFileSize">-</span>
                </div>
                <div class="update-info-row">
                    <span class="label">–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞:</span>
                    <span class="value" id="updatePublishedAt">-</span>
                </div>
            </div>
            
            <div class="update-notes" id="updateNotes" style="display: none;"></div>
            
            <div class="update-progress" id="updateProgress" style="display: none;">
                <div class="update-progress-bar">
                    <div class="update-progress-fill" id="updateProgressFill"></div>
                </div>
                <div class="update-progress-text" id="updateProgressText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <div class="modal-status" id="updateModalStatus"></div>
            
            <div class="modal-buttons" id="updateModalButtons">
                <button class="modal-btn secondary" onclick="closeModal('updateModal')">–ü–æ–∑–∂–µ</button>
                <button class="modal-btn secondary" onclick="openUpdateLink()">üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–ª–∏–∑–∞</button>
                <button class="modal-btn primary" id="installUpdateBtn" onclick="installUpdate()">‚¨áÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const go = {
            main: {
                App: {
                    GetStatus: () => window['go']['main']['App']['GetStatus'](),
                    Start: () => window['go']['main']['App']['Start'](),
                    Stop: () => window['go']['main']['App']['Stop'](),
                    Toggle: () => window['go']['main']['App']['Toggle'](),
                    Quit: () => window['go']['main']['App']['Quit'](),
                    OpenConfigFolder: () => window['go']['main']['App']['OpenConfigFolder'](),
                    OpenLogs: () => window['go']['main']['App']['OpenLogs'](),
                    GetVersion: () => window['go']['main']['App']['GetVersion'](),
                    GetCurrentSubscription: () => window['go']['main']['App']['GetCurrentSubscription'](),
                    TestVPNConnection: (url) => window['go']['main']['App']['TestVPNConnection'](url),
                    SetVPNSubscription: (url) => window['go']['main']['App']['SetVPNSubscription'](url),
                    RemoveVPNSubscription: () => window['go']['main']['App']['RemoveVPNSubscription'](),
                    CanModifyVPN: () => window['go']['main']['App']['CanModifyVPN'](),
                    // WireGuard
                    GetWireGuardList: () => window['go']['main']['App']['GetWireGuardList'](),
                    AddWireGuard: (tag, name, config) => window['go']['main']['App']['AddWireGuard'](tag, name, config),
                    UpdateWireGuard: (oldTag, tag, name, config) => window['go']['main']['App']['UpdateWireGuard'](oldTag, tag, name, config),
                    DeleteWireGuard: (tag) => window['go']['main']['App']['DeleteWireGuard'](tag),
                    GetWireGuardConfig: (tag) => window['go']['main']['App']['GetWireGuardConfig'](tag),
                    ParseWireGuardConfigAPI: (config) => window['go']['main']['App']['ParseWireGuardConfigAPI'](config),
                    // Settings
                    GetAppConfig: () => window['go']['main']['App']['GetAppConfig'](),
                    SaveAppConfig: (autoStart, enableLogging, checkUpdates, notifications, autoUpdateSub, theme, language, logLevel, subUpdateInterval) => 
                        window['go']['main']['App']['SaveAppConfig'](autoStart, enableLogging, checkUpdates, notifications, autoUpdateSub, theme, language, logLevel, subUpdateInterval),
                    // Template
                    GetTemplateContent: () => window['go']['main']['App']['GetTemplateContent'](),
                    SaveTemplateContent: (content) => window['go']['main']['App']['SaveTemplateContent'](content),
                    ResetTemplate: () => window['go']['main']['App']['ResetTemplate'](),
                    // Stats
                    GetTrafficStats: () => window['go']['main']['App']['GetTrafficStats'](),
                    ResetTrafficStats: () => window['go']['main']['App']['ResetTrafficStats'](),
                    UpdateTrafficFromClash: () => window['go']['main']['App']['UpdateTrafficFromClash'](),
                    // Proxy info
                    GetProxiesWithDelay: () => window['go']['main']['App']['GetProxiesWithDelay'](),
                    TestProxyDelay: (name) => window['go']['main']['App']['TestProxyDelay'](name),
                    GetCurrentProxy: () => window['go']['main']['App']['GetCurrentProxy'](),
                    // Updates
                    CheckForUpdates: () => window['go']['main']['App']['CheckForUpdates'](),
                    GetAppVersion: () => window['go']['main']['App']['GetAppVersion'](),
                    DownloadAndInstallUpdate: (url) => window['go']['main']['App']['DownloadAndInstallUpdate'](url),
                    // Logs
                    GetLogs: (lastN) => window['go']['main']['App']['GetLogs'](lastN),
                    ClearLogs: () => window['go']['main']['App']['ClearLogs'](),
                    // Window visibility
                    SetWindowVisible: (visible) => window['go']['main']['App']['SetWindowVisible'](visible),
                    // Profiles
                    GetProfiles: () => window['go']['main']['App']['GetProfiles'](),
                    GetActiveProfile: () => window['go']['main']['App']['GetActiveProfile'](),
                    SetActiveProfile: (id) => window['go']['main']['App']['SetActiveProfile'](id),
                    CreateProfile: (name) => window['go']['main']['App']['CreateProfile'](name),
                    UpdateProfile: (id, name) => window['go']['main']['App']['UpdateProfile'](id, name),
                    DeleteProfile: (id) => window['go']['main']['App']['DeleteProfile'](id),
                }
            }
        };

        let isConnecting = false;
        let isVpnRunning = false;
        let testedVpnUrl = null;
        let currentSubscription = null;
        let wireGuardConfigs = [];
        let editingWgTag = null; // null = adding new, string = editing existing
        let appConfig = null;
        let updateInfo = null;
        let statsUpdateInterval = null;
        let currentProfiles = []; // Profiles list
        let activeProfileId = 1;  // Active profile ID
        let editingProfileId = null; // null = creating, number = editing
        let currentLang = 'ru'; // Current language
        
        // Translations
        const i18n = {
            ru: {
                // Status
                connected: '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ',
                disconnected: '–û—Ç–∫–ª—é—á–µ–Ω–æ',
                connecting: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...',
                disconnecting: '–û—Ç–∫–ª—é—á–µ–Ω–∏–µ...',
                // Badges
                addVpn: '‚ö° –î–æ–±–∞–≤–∏—Ç—å VPN',
                proxies: '–ø—Ä–æ–∫—Å–∏',
                workNetworks: 'üè¢ –†–∞–±–æ—á–∏–µ —Å–µ—Ç–∏',
                // Profile
                profile: '–ü—Ä–æ—Ñ–∏–ª—å',
                profiles: '–ü—Ä–æ—Ñ–∏–ª–∏',
                selectProfile: '–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è',
                createProfile: '‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å',
                newProfile: '‚ûï –ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å',
                editProfile: '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å',
                profileName: '–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è',
                default: '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é',
                noSubscription: '–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏',
                cantDeleteDefault: '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
                deleteProfile: '–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è',
                deleteProfileConfirm: '–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "{name}"? –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.',
                profileCreated: '–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω',
                profileUpdated: '–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω',
                profileDeleted: '–ü—Ä–æ—Ñ–∏–ª—å —É–¥–∞–ª—ë–Ω',
                profileActivated: '–ü—Ä–æ—Ñ–∏–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω',
                disconnectFirst: '–û—Ç–∫–ª—é—á–∏—Ç–µ VPN –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π –ø—Ä–æ—Ñ–∏–ª—è',
                enterProfileName: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è',
                // Settings
                settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                general: '–û–±—â–∏–µ',
                autoStart: '–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫',
                autoStartDesc: '–ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É',
                notifications: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
                notificationsDesc: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏',
                logging: '–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ sing-box',
                loggingDesc: '–ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª',
                logLevel: '–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è',
                logLevelDesc: '–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤ sing-box',
                subscription: '–ü–æ–¥–ø–∏—Å–∫–∞',
                autoUpdate: '–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ',
                autoUpdateDesc: '–û–±–Ω–æ–≤–ª—è—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏',
                updates: '–û–±–Ω–æ–≤–ª–µ–Ω–∏—è',
                checkUpdates: '–ü—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è',
                checkUpdatesDesc: '–£–≤–µ–¥–æ–º–ª—è—Ç—å –æ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö',
                appearance: '–í–Ω–µ—à–Ω–∏–π –≤–∏–¥',
                theme: '–¢–µ–º–∞',
                themeDesc: '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è',
                themeDark: '–¢—ë–º–Ω–∞—è',
                themeLight: '–°–≤–µ—Ç–ª–∞—è',
                themeSystem: '–°–∏—Å—Ç–µ–º–Ω–∞—è',
                language: '–Ø–∑—ã–∫',
                languageDesc: '–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞',
                configuration: '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è',
                templateEditor: '–†–µ–¥–∞–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–∞',
                // Actions
                cancel: '–û—Ç–º–µ–Ω–∞',
                close: '–ó–∞–∫—Ä—ã—Ç—å',
                save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                create: '–°–æ–∑–¥–∞—Ç—å',
                delete: '–£–¥–∞–ª–∏—Ç—å',
                edit: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
                folder: '–ü–∞–ø–∫–∞',
                copy: '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',
                copied: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ',
                settingsSaved: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã',
                // Errors
                error: '–û—à–∏–±–∫–∞',
                warning: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
                // VPN
                vpnConnected: 'VPN –ø–æ–¥–∫–ª—é—á–µ–Ω',
                vpnDisconnected: 'VPN –æ—Ç–∫–ª—é—á–µ–Ω',
                disconnectVpnFirst: '–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ VPN',
                secureConnection: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ',
            },
            en: {
                // Status
                connected: 'Connected',
                disconnected: 'Disconnected',
                connecting: 'Connecting...',
                disconnecting: 'Disconnecting...',
                // Badges
                addVpn: '‚ö° Add VPN',
                proxies: 'proxies',
                workNetworks: 'üè¢ Work networks',
                // Profile
                profile: 'Profile',
                profiles: 'Profiles',
                selectProfile: 'Select or create a connection profile',
                createProfile: '‚ûï Create profile',
                newProfile: '‚ûï New profile',
                editProfile: '‚úèÔ∏è Edit profile',
                profileName: 'Profile name',
                default: 'Default',
                noSubscription: 'No subscription',
                cantDeleteDefault: 'Cannot delete the default profile',
                deleteProfile: 'Delete profile',
                deleteProfileConfirm: 'Delete profile "{name}"? All profile settings will be lost.',
                profileCreated: 'Profile created',
                profileUpdated: 'Profile updated',
                profileDeleted: 'Profile deleted',
                profileActivated: 'Profile activated',
                disconnectFirst: 'Disconnect VPN before switching profile',
                enterProfileName: 'Enter profile name',
                // Settings
                settings: 'Settings',
                general: 'General',
                autoStart: 'Auto-start',
                autoStartDesc: 'Launch at system startup',
                notifications: 'Notifications',
                notificationsDesc: 'Show connection notifications',
                logging: 'sing-box logging',
                loggingDesc: 'Write logs to file',
                logLevel: 'Log level',
                logLevelDesc: 'sing-box log verbosity',
                subscription: 'Subscription',
                autoUpdate: 'Auto-update',
                autoUpdateDesc: 'Update subscription automatically',
                updates: 'Updates',
                checkUpdates: 'Check for updates',
                checkUpdatesDesc: 'Notify about new versions',
                appearance: 'Appearance',
                theme: 'Theme',
                themeDesc: 'App theme',
                themeDark: 'Dark',
                themeLight: 'Light',
                themeSystem: 'System',
                language: 'Language',
                languageDesc: 'Interface language',
                configuration: 'Configuration',
                templateEditor: 'Template editor',
                // Actions
                cancel: 'Cancel',
                close: 'Close',
                save: 'Save',
                create: 'Create',
                delete: 'Delete',
                edit: 'Edit',
                folder: 'Folder',
                copy: 'Copy',
                copied: 'Copied',
                settingsSaved: 'Settings saved',
                // Errors
                error: 'Error',
                warning: 'Warning',
                // VPN
                vpnConnected: 'VPN connected',
                vpnDisconnected: 'VPN disconnected',
                disconnectVpnFirst: 'Disconnect VPN first',
                secureConnection: 'Secure connection',
            }
        };
        
        // Get translation
        function t(key, params = {}) {
            let text = i18n[currentLang][key] || i18n['ru'][key] || key;
            // Replace placeholders like {name}
            Object.keys(params).forEach(k => {
                text = text.replace(`{${k}}`, params[k]);
            });
            return text;
        }
        
        // Apply language to UI
        function applyLanguage(lang) {
            currentLang = lang;
            document.documentElement.setAttribute('lang', lang);
            updateUITexts();
        }
        
        // Update all UI texts
        function updateUITexts() {
            // Status will update on next status update
            // Subtitle
            const subtitle = document.getElementById('activeProfileName');
            if (subtitle && currentProfiles.length > 0) {
                updateActiveProfileDisplay();
            } else if (subtitle) {
                subtitle.textContent = t('secureConnection');
            }
        }

        // Custom confirm dialog
        function showConfirm(message, title = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const okBtn = document.getElementById('confirmOk');
                const cancelBtn = document.getElementById('confirmCancel');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                modal.classList.add('active');
                
                const cleanup = () => {
                    modal.classList.remove('active');
                    okBtn.removeEventListener('click', onOk);
                    cancelBtn.removeEventListener('click', onCancel);
                };
                
                const onOk = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };
                
                okBtn.addEventListener('click', onOk);
                cancelBtn.addEventListener('click', onCancel);
            });
        }

        // Favicon templates
        const faviconGray = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%234a5568'/%3E%3Cpath d='M16 6l-7 3v5c0 4.4 3 8.5 7 9.5 4-1 7-5.1 7-9.5V9l-7-3zm0 8h5.5c-.4 3.3-2.6 6.2-5.5 7.1V14h-5.5V9.5l5.5-2.5v7z' fill='white'/%3E%3C/svg%3E";
        const faviconGreen = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%2322c55e'/%3E%3Cpath d='M16 6l-7 3v5c0 4.4 3 8.5 7 9.5 4-1 7-5.1 7-9.5V9l-7-3zm0 8h5.5c-.4 3.3-2.6 6.2-5.5 7.1V14h-5.5V9.5l5.5-2.5v7z' fill='white'/%3E%3C/svg%3E";
        const faviconOrange = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%23f59e0b'/%3E%3Cpath d='M16 6l-7 3v5c0 4.4 3 8.5 7 9.5 4-1 7-5.1 7-9.5V9l-7-3zm0 8h5.5c-.4 3.3-2.6 6.2-5.5 7.1V14h-5.5V9.5l5.5-2.5v7z' fill='white'/%3E%3C/svg%3E";
        const faviconRed = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%23ef4444'/%3E%3Cpath d='M16 6l-7 3v5c0 4.4 3 8.5 7 9.5 4-1 7-5.1 7-9.5V9l-7-3zm0 8h5.5c-.4 3.3-2.6 6.2-5.5 7.1V14h-5.5V9.5l5.5-2.5v7z' fill='white'/%3E%3C/svg%3E";

        function setFavicon(status) {
            const oldLink = document.getElementById('favicon');
            const newLink = document.createElement('link');
            newLink.id = 'favicon'; newLink.rel = 'icon'; newLink.type = 'image/svg+xml';
            const logo = document.querySelector('.logo');
            
            if (status === 'connected') {
                newLink.href = faviconGreen;
                document.title = 'üü¢ Kampus VPN - –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                if (logo) logo.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
            } else if (status === 'connecting') {
                newLink.href = faviconOrange;
                document.title = 'üü° Kampus VPN - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                if (logo) logo.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else if (status === 'error') {
                newLink.href = faviconRed;
                document.title = 'üî¥ Kampus VPN - –û—à–∏–±–∫–∞';
                if (logo) logo.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } else {
                newLink.href = faviconGray;
                document.title = 'Kampus VPN';
                if (logo) logo.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            
            if (oldLink && oldLink.parentNode) oldLink.parentNode.removeChild(oldLink);
            document.head.appendChild(newLink);
        }

        async function updateStatus() {
            try {
                const status = await go.main.App.GetStatus();
                const btn = document.getElementById('powerBtn');
                const statusEl = document.getElementById('status');
                const errorEl = document.getElementById('error');
                const serversPanel = document.getElementById('serversPanel');
                const profileLogo = document.getElementById('profileLogo');
                
                isVpnRunning = status.running;
                updateBadgesState();
                
                // Update profile logo state
                if (profileLogo) {
                    if (status.running) {
                        profileLogo.classList.add('disabled');
                        profileLogo.title = '–û—Ç–∫–ª—é—á–∏—Ç–µ VPN –¥–ª—è —Å–º–µ–Ω—ã –ø—Ä–æ—Ñ–∏–ª—è';
                    } else {
                        profileLogo.classList.remove('disabled');
                        profileLogo.title = '–í—ã–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
                    }
                }
                
                if (status.running) {
                    btn.classList.add('active');
                    statusEl.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    statusEl.className = 'status connected';
                    errorEl.innerHTML = '';
                    setFavicon('connected');
                    serversPanel.style.display = 'block';
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Ä–≤–µ—Ä—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π —á—Ç–æ–±—ã API —É—Å–ø–µ–ª –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
                    setTimeout(() => updateServersPanel(), 500);
                } else {
                    btn.classList.remove('active');
                    statusEl.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                    statusEl.className = 'status disconnected';
                    // Show error icon if there was an error, otherwise disconnected
                    if (status.hasError) {
                        setFavicon('error');
                    } else {
                        setFavicon('disconnected');
                    }
                    serversPanel.style.display = 'none';
                    stopPingUpdates();
                }
                
                if (!status.singboxExists) {
                    errorEl.innerHTML = '<div class="error">‚ö†Ô∏è sing-box –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                }
                
                btn.disabled = false;
                isConnecting = false;
                document.body.classList.remove('connecting');
            } catch (e) {
                console.error('Error updating status:', e);
            }
        }

        // Servers management
        let allServers = [];
        let currentProxy = '';
        let pingUpdateInterval = null;
        let isAppVisible = true;
        let isPingLoading = false;
        const MAX_VISIBLE_SERVERS = 3;
        const PING_UPDATE_INTERVAL = 15000; // 15 —Å–µ–∫—É–Ω–¥

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('visibilitychange', () => {
            isAppVisible = !document.hidden;
            if (isAppVisible && isVpnRunning) {
                // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                updateServersPanel();
                startPingUpdates();
            } else {
                stopPingUpdates();
            }
        });

        function startPingUpdates() {
            if (pingUpdateInterval) return;
            // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º
            updateServersPanel();
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
            pingUpdateInterval = setInterval(() => {
                if (isAppVisible && isVpnRunning && !isPingLoading) {
                    updateServersPanel();
                }
            }, PING_UPDATE_INTERVAL);
        }

        function stopPingUpdates() {
            if (pingUpdateInterval) {
                clearInterval(pingUpdateInterval);
                pingUpdateInterval = null;
            }
        }

        async function updateServersPanel() {
            console.log('[updateServersPanel] Starting...');
            if (isPingLoading) {
                console.log('[updateServersPanel] Already loading, skipping');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
            if (!window.go || !window.go.main || !window.go.main.App || !window.go.main.App.TestAllProxiesDelay) {
                console.log('[updateServersPanel] Wails runtime not ready, retrying in 500ms...');
                setTimeout(() => updateServersPanel(), 500);
                return;
            }
            
            isPingLoading = true;
            
            try {
                console.log('[updateServersPanel] Calling TestAllProxiesDelay...');
                const result = await window.go.main.App.TestAllProxiesDelay();
                console.log('[updateServersPanel] Result:', JSON.stringify(result));
                if (!result.success) {
                    console.log('[updateServersPanel] Result not successful');
                    return;
                }

                allServers = result.proxies || [];
                currentProxy = result.currentProxy || '';
                console.log('[updateServersPanel] Got', allServers.length, 'servers, current:', currentProxy);

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–π, –ø–æ—Ç–æ–º –ø–æ –ø–∏–Ω–≥—É
                allServers.sort((a, b) => {
                    if (a.name === currentProxy) return -1;
                    if (b.name === currentProxy) return 1;
                    if (a.delay === 0) return 1;
                    if (b.delay === 0) return -1;
                    return a.delay - b.delay;
                });

                renderServersList();
                renderServersModal();
            } catch (e) {
                console.error('Error updating servers:', e);
            } finally {
                isPingLoading = false;
            }
        }

        function renderServersList() {
            const list = document.getElementById('serversList');
            const showAllBtn = document.getElementById('showAllServersBtn');
            const totalCount = document.getElementById('totalServersCount');

            const visibleServers = allServers.slice(0, MAX_VISIBLE_SERVERS);
            
            list.innerHTML = visibleServers.map(server => createServerItem(server)).join('');

            if (allServers.length > MAX_VISIBLE_SERVERS) {
                showAllBtn.style.display = 'block';
                totalCount.textContent = allServers.length;
            } else {
                showAllBtn.style.display = 'none';
            }
        }

        function renderServersModal() {
            const list = document.getElementById('serversModalList');
            if (list) {
                list.innerHTML = allServers.map(server => createServerItem(server)).join('');
            }
        }

        function createServerItem(server) {
            const isActive = server.name === currentProxy;
            const isInternal = server.isInternal || false;
            let pingClass, pingText;
            
            if (server.delay === -1) {
                // WireGuard –∞–∫—Ç–∏–≤–µ–Ω –Ω–æ –ø–∏–Ω–≥ –Ω–µ –∏–∑–º–µ—Ä—è–µ—Ç—Å—è
                pingClass = 'ping-active';
                pingText = '–ê–∫—Ç–∏–≤–µ–Ω';
            } else if (server.delay > 0) {
                pingClass = getPingClass(server.delay);
                pingText = `${server.delay} ms`;
            } else {
                pingClass = 'ping-timeout';
                pingText = '---';
            }
            
            const displayName = formatServerName(server.name);
            
            return `
                <div class="server-item ${isActive ? 'active' : ''} ${isInternal ? 'internal' : ''}">
                    <span class="server-name" title="${server.name}">${displayName}</span>
                    <span class="server-ping ${pingClass}">${pingText}</span>
                </div>
            `;
        }

        function formatServerName(name) {
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å—ã —Ç–∏–ø–∞ "-Marz-" –∏ —Å—É—Ñ—Ñ–∏–∫—Å—ã —Ç–∏–ø–∞ "---tcp"
            let formatted = name
                .replace(/^-+/, '')
                .replace(/-+$/, '')
                .replace(/---/g, ' - ')
                .replace(/--/g, ' ')
                .replace(/-/g, ' ');
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
            if (formatted.length > 28) {
                formatted = formatted.substring(0, 25) + '...';
            }
            return formatted;
        }

        function getPingClass(delay) {
            if (delay === 0) return 'timeout';
            if (delay < 150) return 'good';
            if (delay < 400) return 'medium';
            return 'bad';
        }

        function openServersModal() {
            renderServersModal();
            document.getElementById('serversModal').classList.add('active');
        }

        function updateBadgesState() {
            const vpnBadge = document.getElementById('vpnBadge');
            const wgBadge = document.getElementById('wgBadge');
            const settingsBtn = document.getElementById('settingsBtn');
            
            if (isVpnRunning) {
                vpnBadge.classList.add('disabled');
                wgBadge.classList.add('disabled');
                settingsBtn.classList.add('disabled');
                settingsBtn.title = '–û—Ç–∫–ª—é—á–∏—Ç–µ VPN –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫';
            } else {
                vpnBadge.classList.remove('disabled');
                wgBadge.classList.remove('disabled');
                settingsBtn.classList.remove('disabled');
                settingsBtn.title = '';
            }
        }

        async function updateSubscriptionBadge() {
            try {
                const sub = await go.main.App.GetCurrentSubscription();
                const badge = document.getElementById('vpnBadge');
                currentSubscription = sub;
                
                if (sub.hasSubscription) {
                    badge.classList.remove('no-sub');
                    badge.innerHTML = `<span>üîó VPN: ${sub.proxyCount} —Å–µ—Ä–≤–µ—Ä–æ–≤</span><span class="tooltip">–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ VPN</span>`;
                } else {
                    badge.classList.add('no-sub');
                    badge.innerHTML = '<span>‚ö° –î–æ–±–∞–≤–∏—Ç—å VPN</span><span class="tooltip">–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ VPN</span>';
                }
            } catch (e) {
                console.error('Error updating subscription badge:', e);
            }
        }

        async function updateWireGuardBadge() {
            try {
                const result = await go.main.App.GetWireGuardList();
                const badge = document.getElementById('wgBadge');
                wireGuardConfigs = result.configs || [];
                
                if (wireGuardConfigs.length > 0) {
                    badge.classList.remove('no-wg');
                    badge.innerHTML = `<span>üè¢ –†–∞–±–æ—á–∏–µ —Å–µ—Ç–∏: ${wireGuardConfigs.length}</span><span class="tooltip">–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ VPN</span>`;
                } else {
                    badge.classList.add('no-wg');
                    badge.innerHTML = '<span>üè¢ –†–∞–±–æ—á–∏–µ —Å–µ—Ç–∏: 0</span><span class="tooltip">–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∏—Ç–µ VPN</span>';
                }
            } catch (e) {
                console.error('Error updating WireGuard badge:', e);
            }
        }

        async function toggle() {
            if (isConnecting) return;
            
            // Check if VPN subscription exists
            if (!currentSubscription?.hasSubscription && !isVpnRunning) {
                showError('–î–æ–±–∞–≤—å—Ç–µ VPN –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
                return;
            }
            
            const btn = document.getElementById('powerBtn');
            const statusEl = document.getElementById('status');
            const errorEl = document.getElementById('error');
            
            isConnecting = true;
            btn.disabled = true;
            statusEl.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            statusEl.className = 'status connecting';
            document.body.classList.add('connecting');
            errorEl.innerHTML = '';
            setFavicon('connecting');
            
            try {
                const result = await go.main.App.Toggle();
                if (!result.success && result.error) {
                    errorEl.innerHTML = `<div class="error">‚ùå ${result.error}</div>`;
                }
            } catch (e) {
                errorEl.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
            }
            
            // –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫ Clash API (2 —Å–µ–∫)
            setTimeout(async () => {
                await updateStatus();
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∏–Ω–≥–æ–≤ –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
                if (isVpnRunning) {
                    startPingUpdates();
                }
            }, 2000);
        }

        function showError(msg) {
            document.getElementById('error').innerHTML = `<div class="error">‚ö†Ô∏è ${msg}</div>`;
            setTimeout(() => { document.getElementById('error').innerHTML = ''; }, 3000);
        }

        // Badge click handlers
        function handleVpnBadgeClick() {
            if (isVpnRunning) return;
            openVpnModal();
        }

        function handleWgBadgeClick() {
            if (isVpnRunning) return;
            openWgListModal();
        }

        // VPN Modal
        function openVpnModal() {
            const input = document.getElementById('subscriptionInput');
            const currentSubDiv = document.getElementById('currentSub');
            const currentSubUrl = document.getElementById('currentSubUrl');
            const removeBtn = document.getElementById('removeVpnBtn');
            
            resetVpnModalState();
            
            if (currentSubscription && currentSubscription.hasSubscription) {
                currentSubDiv.style.display = 'block';
                currentSubUrl.textContent = truncateUrl(currentSubscription.url);
                removeBtn.style.display = 'inline-block';
                input.value = currentSubscription.url;
            } else {
                currentSubDiv.style.display = 'none';
                removeBtn.style.display = 'none';
                input.value = '';
            }
            
            document.getElementById('vpnModal').classList.add('active');
            input.focus();
        }

        function resetVpnModalState() {
            document.getElementById('vpnModalStatus').className = 'modal-status';
            document.getElementById('vpnModalStatus').textContent = '';
            document.getElementById('proxyList').style.display = 'none';
            document.getElementById('saveVpnBtn').style.display = 'none';
            document.getElementById('testVpnBtn').style.display = 'inline-block';
            testedVpnUrl = null;
        }

        async function testSubscription() {
            const url = document.getElementById('subscriptionInput').value.trim();
            if (!url) { showVpnModalStatus('error', '–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É'); return; }
            
            showVpnModalStatus('loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
            document.getElementById('testVpnBtn').disabled = true;
            
            try {
                const result = await go.main.App.TestVPNConnection(url);
                if (result.success) {
                    testedVpnUrl = url;
                    showVpnModalStatus('success', `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${result.count} —Å–µ—Ä–≤–µ—Ä–æ–≤`);
                    
                    const proxyList = document.getElementById('proxyList');
                    proxyList.innerHTML = result.proxies.map(p => 
                        `<div class="proxy-item"><span class="type">${p.type}</span><span>${p.name || p.server}</span></div>`
                    ).join('');
                    proxyList.style.display = 'block';
                    
                    document.getElementById('testVpnBtn').style.display = 'none';
                    document.getElementById('saveVpnBtn').style.display = 'inline-block';
                } else {
                    showVpnModalStatus('error', `‚ùå ${result.error}`);
                }
            } catch (e) {
                showVpnModalStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
            }
            document.getElementById('testVpnBtn').disabled = false;
        }

        async function saveSubscription() {
            if (!testedVpnUrl) return;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤–æ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const saveBtn = document.getElementById('saveVpnBtn');
            const testBtn = document.getElementById('testVpnBtn');
            const cancelBtn = document.querySelector('#vpnModal .modal-btn:not(.primary)');
            saveBtn.disabled = true;
            testBtn.disabled = true;
            if (cancelBtn) cancelBtn.disabled = true;
            
            showVpnModalStatus('loading', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏...');
            
            try {
                const result = await go.main.App.SetVPNSubscription(testedVpnUrl);
                if (result.success) {
                    showVpnModalStatus('success', `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! ${result.proxyCount} —Å–µ—Ä–≤–µ—Ä–æ–≤`);
                    await updateSubscriptionBadge();
                    setTimeout(() => closeModal('vpnModal'), 1000);
                } else {
                    showVpnModalStatus('error', `‚ùå ${result.error}`);
                    saveBtn.disabled = false;
                    testBtn.disabled = false;
                    if (cancelBtn) cancelBtn.disabled = false;
                }
            } catch (e) {
                showVpnModalStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
                saveBtn.disabled = false;
                testBtn.disabled = false;
                if (cancelBtn) cancelBtn.disabled = false;
            }
        }

        async function removeSubscription() {
            const confirmed = await showConfirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É?', '–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏');
            if (!confirmed) return;
            showVpnModalStatus('loading', '–£–¥–∞–ª–µ–Ω–∏–µ...');
            
            try {
                const result = await go.main.App.RemoveVPNSubscription();
                if (result.success) {
                    showVpnModalStatus('success', '‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                    await updateSubscriptionBadge();
                    document.getElementById('subscriptionInput').value = '';
                    document.getElementById('currentSub').style.display = 'none';
                    document.getElementById('removeVpnBtn').style.display = 'none';
                    setTimeout(() => closeModal('vpnModal'), 1000);
                } else {
                    showVpnModalStatus('error', `‚ùå ${result.error}`);
                }
            } catch (e) {
                showVpnModalStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
            }
        }

        function showVpnModalStatus(type, message) {
            const status = document.getElementById('vpnModalStatus');
            status.className = `modal-status ${type}`;
            status.textContent = message;
        }

        // WireGuard List Modal
        async function openWgListModal() {
            await updateWireGuardList();
            document.getElementById('wgListModal').classList.add('active');
        }

        async function updateWireGuardList() {
            try {
                const result = await go.main.App.GetWireGuardList();
                wireGuardConfigs = result.configs || [];
                
                const listEl = document.getElementById('wgList');
                if (wireGuardConfigs.length === 0) {
                    listEl.innerHTML = '<div class="empty-state">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö WireGuard –∫–æ–Ω—Ñ–∏–≥–æ–≤</div>';
                } else {
                    listEl.innerHTML = wireGuardConfigs.map(wg => {
                        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º AllowedIPs –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        const networks = wg.allowed_ips ? wg.allowed_ips.slice(0, 3).join(', ') : '';
                        const moreNetworks = wg.allowed_ips && wg.allowed_ips.length > 3 ? ` +${wg.allowed_ips.length - 3}` : '';
                        return `
                        <div class="wg-item" onclick="editWireGuard('${wg.tag}')">
                            <div class="wg-item-info">
                                <div class="wg-item-header">
                                    <span class="tag">${wg.tag}</span>
                                    <span style="margin-left: 8px; color: #8892b0;">${wg.name || ''}</span>
                                </div>
                                <div class="wg-item-networks" title="${wg.allowed_ips ? wg.allowed_ips.join(', ') : ''}">
                                    üåê ${networks}${moreNetworks}
                                </div>
                            </div>
                            <div class="actions">
                                <button class="edit" onclick="event.stopPropagation(); editWireGuard('${wg.tag}')">‚úèÔ∏è</button>
                                <button class="delete" onclick="event.stopPropagation(); confirmDeleteWg('${wg.tag}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `}).join('');
                }
            } catch (e) {
                console.error('Error loading WireGuard list:', e);
            }
        }

        function openAddWgModal() {
            editingWgTag = null;
            document.getElementById('wgEditTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å WireGuard';
            document.getElementById('wgTag').value = '';
            document.getElementById('wgName').value = '';
            document.getElementById('wgConfig').value = '';
            document.getElementById('deleteWgBtn').style.display = 'none';
            document.getElementById('saveWgBtn').style.display = 'none';
            document.getElementById('parseWgBtn').style.display = 'inline-block';
            document.getElementById('wgModalStatus').className = 'modal-status';
            document.getElementById('wgEditModal').classList.add('active');
        }

        async function editWireGuard(tag) {
            try {
                const result = await go.main.App.GetWireGuardConfig(tag);
                if (!result.success) {
                    alert(result.error);
                    return;
                }
                
                editingWgTag = tag;
                document.getElementById('wgEditTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å WireGuard';
                document.getElementById('wgTag').value = result.tag;
                document.getElementById('wgName').value = result.name || '';
                
                // Reconstruct config text
                let config = `[Interface]\nPrivateKey = ${result.private_key}\nAddress = ${result.local_address.join(', ')}`;
                if (result.dns) config += `\nDNS = ${result.dns}`;
                if (result.mtu) config += `\nMTU = ${result.mtu}`;
                config += `\n\n[Peer]\nPublicKey = ${result.public_key}`;
                if (result.preshared_key) config += `\nPresharedKey = ${result.preshared_key}`;
                config += `\nAllowedIPs = ${result.allowed_ips.join(', ')}`;
                config += `\nEndpoint = ${result.endpoint}`;
                if (result.persistent_keepalive) config += `\nPersistentKeepalive = ${result.persistent_keepalive}`;
                
                document.getElementById('wgConfig').value = config;
                document.getElementById('deleteWgBtn').style.display = 'inline-block';
                document.getElementById('saveWgBtn').style.display = 'none';
                document.getElementById('parseWgBtn').style.display = 'inline-block';
                document.getElementById('wgModalStatus').className = 'modal-status';
                document.getElementById('wgEditModal').classList.add('active');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        async function parseWireGuard() {
            const tag = document.getElementById('wgTag').value.trim();
            const config = document.getElementById('wgConfig').value.trim();
            
            if (!tag) { showWgModalStatus('error', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥'); return; }
            if (!config) { showWgModalStatus('error', '–í—Å—Ç–∞–≤—å—Ç–µ WireGuard –∫–æ–Ω—Ñ–∏–≥'); return; }
            
            // Validate tag
            if (!/^[a-zA-Z][a-zA-Z0-9_-]*$/.test(tag)) {
                showWgModalStatus('error', '–¢–µ–≥ –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –±—É–∫–≤—ã –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å –∏–ª–∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ');
                return;
            }
            
            showWgModalStatus('loading', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞...');
            
            try {
                const result = await go.main.App.ParseWireGuardConfigAPI(config);
                if (result.success) {
                    showWgModalStatus('success', `‚úÖ –ö–æ–Ω—Ñ–∏–≥ –≤–∞–ª–∏–¥–µ–Ω. Endpoint: ${result.endpoint}`);
                    document.getElementById('parseWgBtn').style.display = 'none';
                    document.getElementById('saveWgBtn').style.display = 'inline-block';
                } else {
                    showWgModalStatus('error', `‚ùå ${result.error}`);
                }
            } catch (e) {
                showWgModalStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
            }
        }

        async function saveWireGuard() {
            const tag = document.getElementById('wgTag').value.trim();
            const name = document.getElementById('wgName').value.trim();
            const config = document.getElementById('wgConfig').value.trim();
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤–æ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const saveBtn = document.getElementById('saveWgBtn');
            const cancelBtn = document.querySelector('#wgEditModal .modal-btn:not(.primary)');
            saveBtn.disabled = true;
            if (cancelBtn) cancelBtn.disabled = true;
            
            showWgModalStatus('loading', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');
            
            try {
                let result;
                if (editingWgTag) {
                    result = await go.main.App.UpdateWireGuard(editingWgTag, tag, name, config);
                } else {
                    result = await go.main.App.AddWireGuard(tag, name, config);
                }
                
                if (result.success) {
                    showWgModalStatus('success', '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                    await updateWireGuardBadge();
                    await updateWireGuardList();
                    setTimeout(() => closeWgEditModal(), 1000);
                } else {
                    showWgModalStatus('error', `‚ùå ${result.error}`);
                    saveBtn.disabled = false;
                    if (cancelBtn) cancelBtn.disabled = false;
                }
            } catch (e) {
                showWgModalStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
                saveBtn.disabled = false;
                if (cancelBtn) cancelBtn.disabled = false;
            }
        }

        async function confirmDeleteWg(tag) {
            const confirmed = await showConfirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–±–æ—á—É—é —Å–µ—Ç—å "${tag}"?`, '–£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ç–∏');
            if (!confirmed) return;
            
            try {
                const result = await go.main.App.DeleteWireGuard(tag);
                if (result.success) {
                    await updateWireGuardBadge();
                    await updateWireGuardList();
                } else {
                    alert(result.error);
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        async function deleteWireGuard() {
            if (!editingWgTag) return;
            const confirmed = await showConfirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–±–æ—á—É—é —Å–µ—Ç—å "${editingWgTag}"?`, '–£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ç–∏');
            if (!confirmed) return;
            
            try {
                const result = await go.main.App.DeleteWireGuard(editingWgTag);
                if (result.success) {
                    await updateWireGuardBadge();
                    await updateWireGuardList();
                    closeWgEditModal();
                } else {
                    showWgModalStatus('error', `‚ùå ${result.error}`);
                }
            } catch (e) {
                showWgModalStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
            }
        }

        function closeWgEditModal() {
            document.getElementById('wgEditModal').classList.remove('active');
            editingWgTag = null;
        }

        function showWgModalStatus(type, message) {
            const status = document.getElementById('wgModalStatus');
            status.className = `modal-status ${type}`;
            status.textContent = message;
        }

        // About Modal
        async function openAbout() {
            document.getElementById('aboutModal').classList.add('active');
            try {
                const config = await go.main.App.GetAppConfig();
                if (config.success) {
                    document.getElementById('aboutVersion').textContent = 'v' + config.appVersion;
                    document.getElementById('aboutSingboxVersion').textContent = 'v' + config.singboxVersion;
                    // Update build info if available
                    const buildInfo = document.getElementById('aboutBuildInfo');
                    if (buildInfo && config.buildHash) {
                        buildInfo.textContent = `Build: ${config.buildHash} (${config.buildTime})`;
                    }
                } else {
                    // Fallback to old method
                    const version = await go.main.App.GetVersion();
                    document.getElementById('aboutSingboxVersion').textContent = version;
                }
            } catch (e) {
                document.getElementById('aboutSingboxVersion').textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
        }

        // ==================== Settings ====================
        async function openSettings() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º VPN
            if (isVpnRunning) {
                showToast('warning', '–û—Ç–∫–ª—é—á–∏—Ç–µ VPN –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                return;
            }
            
            try {
                const config = await go.main.App.GetAppConfig();
                if (config.success) {
                    appConfig = config;
                    document.getElementById('settingAutoStart').checked = config.autoStart;
                    document.getElementById('settingNotifications').checked = config.notifications;
                    document.getElementById('settingCheckUpdates').checked = config.checkUpdates;
                    document.getElementById('settingAutoUpdateSub').checked = config.autoUpdateSub;
                    document.getElementById('settingEnableLogging').checked = config.enableLogging;
                    document.getElementById('settingTheme').value = config.theme || 'dark';
                    document.getElementById('settingLanguage').value = config.language || 'ru';
                    // Log level
                    const logLevelSelect = document.getElementById('logLevelSelect');
                    if (logLevelSelect) {
                        logLevelSelect.value = config.logLevel || 'warn';
                    }
                }
            } catch (e) {
                console.error('Error loading settings:', e);
            }
            document.getElementById('settingsModal').classList.add('active');
        }

        async function saveSettings() {
            try {
                const autoStart = document.getElementById('settingAutoStart').checked;
                const notifications = document.getElementById('settingNotifications').checked;
                const checkUpdates = document.getElementById('settingCheckUpdates').checked;
                const autoUpdateSub = document.getElementById('settingAutoUpdateSub').checked;
                const enableLogging = document.getElementById('settingEnableLogging').checked;
                const theme = document.getElementById('settingTheme').value;
                const language = document.getElementById('settingLanguage').value;
                const logLevel = document.getElementById('logLevelSelect')?.value || 'warn';
                
                const result = await go.main.App.SaveAppConfig(
                    autoStart, enableLogging, checkUpdates, notifications, autoUpdateSub, theme, language, logLevel, 24
                );
                
                if (result.success) {
                    showToast('success', t('settingsSaved'));
                    closeModal('settingsModal');
                    applyTheme(theme);
                    applyLanguage(language);
                } else {
                    showToast('error', result.error || t('error'));
                }
            } catch (e) {
                showToast('error', t('error') + ': ' + e.message);
            }
        }
        
        // ==================== Import/Export Profiles ====================
        async function exportProfiles() {
            try {
                // Check if method exists
                if (!window.go?.main?.App?.ExportProfilesToFile) {
                    console.error('ExportProfilesToFile not found. Available methods:', Object.keys(window.go?.main?.App || {}));
                    showToast('error', '–ú–µ—Ç–æ–¥ —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                    return;
                }
                
                const result = await window.go.main.App.ExportProfilesToFile();
                
                if (result.success) {
                    showToast('success', `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${result.profiles_count} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                } else {
                    if (result.error !== '–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º') {
                        showToast('error', result.error || '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
                    }
                }
            } catch (e) {
                console.error('Export profiles error:', e);
                showToast('error', '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message);
            }
        }
        
        async function importProfiles() {
            try {
                // Check if method exists
                if (!window.go?.main?.App?.ImportProfilesFromFile) {
                    console.error('ImportProfilesFromFile not found. Available methods:', Object.keys(window.go?.main?.App || {}));
                    showToast('error', '–ú–µ—Ç–æ–¥ –∏–º–ø–æ—Ä—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                    return;
                }
                
                const result = await window.go.main.App.ImportProfilesFromFile();
                
                if (!result.success) {
                    if (result.error !== '–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º') {
                        showToast('error', result.error || '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                    }
                    return;
                }
                
                // Show confirmation dialog
                if (result.needs_confirmation) {
                    showImportConfirmDialog(result);
                }
            } catch (e) {
                console.error('Import profiles error:', e);
                showToast('error', '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + e.message);
            }
        }
        
        function showImportConfirmDialog(validationResult) {
            const profileNames = validationResult.profile_names || [];
            const profilesList = profileNames.map(name => `‚Ä¢ ${name}`).join('\n');
            
            const message = `–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏?

–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${validationResult.profiles_count}
WireGuard –∫–æ–Ω—Ñ–∏–≥–æ–≤: ${validationResult.wireguard_count}
–í–∫–ª—é—á–∞–µ—Ç —à–∞–±–ª–æ–Ω: ${validationResult.has_template ? '–î–∞' : '–ù–µ—Ç'}

–ü—Ä–æ—Ñ–∏–ª–∏:
${profilesList}

‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã!`;
            
            if (confirm(message)) {
                confirmImport(validationResult.file_data);
            }
        }
        
        async function confirmImport(jsonData) {
            try {
                const result = await go.main.App.ConfirmImportProfiles(jsonData);
                
                if (result.success) {
                    showToast('success', `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${result.profiles_count} –ø—Ä–æ—Ñ–∏–ª–µ–π`);
                    // Reload profiles UI
                    loadProfiles();
                    loadWireGuardServers();
                } else {
                    showToast('error', result.error || '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                }
            } catch (e) {
                console.error('Confirm import error:', e);
                showToast('error', '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + e.message);
            }
        }
        
        // Apply theme to UI
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            if (theme === 'system') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
            }
        }

        // ==================== Template Editor ====================
        async function openTemplateEditor() {
            const statusEl = document.getElementById('templateModalStatus');
            statusEl.className = 'modal-status loading';
            statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            statusEl.style.display = 'block';
            
            document.getElementById('templateModal').classList.add('active');
            
            try {
                const result = await go.main.App.GetTemplateContent();
                if (result.success) {
                    document.getElementById('templateEditor').value = result.content;
                    statusEl.style.display = 'none';
                } else {
                    statusEl.className = 'modal-status error';
                    statusEl.textContent = result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å template.json';
                }
            } catch (e) {
                statusEl.className = 'modal-status error';
                statusEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
            }
        }

        async function saveTemplate() {
            const statusEl = document.getElementById('templateModalStatus');
            const content = document.getElementById('templateEditor').value;
            
            // Validate JSON before saving
            try {
                JSON.parse(content);
            } catch (e) {
                statusEl.className = 'modal-status error';
                statusEl.textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: ' + e.message;
                statusEl.style.display = 'block';
                return;
            }
            
            statusEl.className = 'modal-status loading';
            statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            statusEl.style.display = 'block';
            
            try {
                const result = await go.main.App.SaveTemplateContent(content);
                if (result.success) {
                    statusEl.className = 'modal-status success';
                    statusEl.textContent = 'Template —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è VPN.';
                    setTimeout(() => {
                        closeModal('templateModal');
                        showToast('success', 'Template.json —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                    }, 1500);
                } else {
                    statusEl.className = 'modal-status error';
                    statusEl.textContent = result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
                }
            } catch (e) {
                statusEl.className = 'modal-status error';
                statusEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
            }
        }

        async function resetTemplate() {
            const confirmed = await showConfirm(
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å template.json –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é? –í—Å–µ –≤–∞—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.',
                '–°–±—Ä–æ—Å Template'
            );
            
            if (!confirmed) return;
            
            const statusEl = document.getElementById('templateModalStatus');
            statusEl.className = 'modal-status loading';
            statusEl.textContent = '–°–±—Ä–æ—Å...';
            statusEl.style.display = 'block';
            
            try {
                const result = await go.main.App.ResetTemplate();
                if (result.success) {
                    // Reload the template content
                    const loadResult = await go.main.App.GetTemplateContent();
                    if (loadResult.success) {
                        document.getElementById('templateEditor').value = loadResult.content;
                    }
                    statusEl.className = 'modal-status success';
                    statusEl.textContent = 'Template —Å–±—Ä–æ—à–µ–Ω –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é';
                    showToast('success', 'Template.json —Å–±—Ä–æ—à–µ–Ω');
                } else {
                    statusEl.className = 'modal-status error';
                    statusEl.textContent = result.error || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞';
                }
            } catch (e) {
                statusEl.className = 'modal-status error';
                statusEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
            }
        }

        // ==================== Stats ====================
        // Speed history for chart (last 30 data points)
        const speedHistory = {
            upload: new Array(30).fill(0),
            download: new Array(30).fill(0),
            lastUpload: 0,
            lastDownload: 0
        };
        
        async function openStats() {
            await updateStats();
            drawCharts();
            document.getElementById('statsModal').classList.add('active');
            // Update stats every 2 seconds while modal is open
            statsUpdateInterval = setInterval(async () => {
                await updateStats();
                drawCharts();
            }, 2000);
        }

        async function updateStats() {
            try {
                // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞—Ñ–∏–∫ –∏–∑ Clash API (–µ—Å–ª–∏ VPN –∑–∞–ø—É—â–µ–Ω)
                if (isVpnRunning) {
                    await go.main.App.UpdateTrafficFromClash();
                }
                
                const stats = await go.main.App.GetTrafficStats();
                if (stats.success) {
                    // Calculate speed (difference from last update)
                    const currentUpload = stats.current.uploaded || 0;
                    const currentDownload = stats.current.downloaded || 0;
                    
                    const uploadSpeed = Math.max(0, currentUpload - speedHistory.lastUpload);
                    const downloadSpeed = Math.max(0, currentDownload - speedHistory.lastDownload);
                    
                    // Update history
                    speedHistory.upload.shift();
                    speedHistory.upload.push(uploadSpeed / 2); // per second (2s interval)
                    speedHistory.download.shift();
                    speedHistory.download.push(downloadSpeed / 2);
                    speedHistory.lastUpload = currentUpload;
                    speedHistory.lastDownload = currentDownload;
                    
                    // Current session
                    document.getElementById('statCurrentUpload').textContent = stats.current.uploadedStr;
                    document.getElementById('statCurrentDownload').textContent = stats.current.downloadedStr;
                    document.getElementById('statCurrentDuration').textContent = stats.current.durationStr;
                    
                    // Total
                    document.getElementById('statTotalUpload').textContent = stats.total.uploadedStr;
                    document.getElementById('statTotalDownload').textContent = stats.total.downloadedStr;
                    document.getElementById('statTotalDuration').textContent = stats.total.durationStr;
                    document.getElementById('statTotalSessions').textContent = stats.total.sessions;
                }
            } catch (e) {
                console.error('Error updating stats:', e);
            }
        }
        
        function drawCharts() {
            drawSpeedChart();
            drawTrafficChart();
        }
        
        function drawSpeedChart() {
            const canvas = document.getElementById('speedChart');
            if (!canvas) return;
            
            // Set canvas size to match container
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth - 24; // padding
            canvas.width = containerWidth;
            canvas.height = 100;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear
            ctx.clearRect(0, 0, width, height);
            
            // Find max value for scaling
            const maxSpeed = Math.max(...speedHistory.upload, ...speedHistory.download, 1024); // min 1KB
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw download line (blue)
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            speedHistory.download.forEach((val, i) => {
                const x = (width / (speedHistory.download.length - 1)) * i;
                const y = height - (val / maxSpeed) * (height - 10);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Draw upload line (green)
            ctx.strokeStyle = '#22c55e';
            ctx.beginPath();
            speedHistory.upload.forEach((val, i) => {
                const x = (width / (speedHistory.upload.length - 1)) * i;
                const y = height - (val / maxSpeed) * (height - 10);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Legend
            ctx.font = '10px sans-serif';
            ctx.fillStyle = '#22c55e';
            ctx.fillText('‚Üë ' + formatSpeed(speedHistory.upload[speedHistory.upload.length - 1]), 5, 12);
            ctx.fillStyle = '#3b82f6';
            ctx.fillText('‚Üì ' + formatSpeed(speedHistory.download[speedHistory.download.length - 1]), 80, 12);
        }
        
        function drawTrafficChart() {
            const canvas = document.getElementById('trafficChart');
            if (!canvas) return;
            
            // Set canvas size to match container
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth - 24; // padding
            canvas.width = containerWidth;
            canvas.height = 80;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Get current stats
            const uploadEl = document.getElementById('statCurrentUpload');
            const downloadEl = document.getElementById('statCurrentDownload');
            const uploadText = uploadEl ? uploadEl.textContent : '0 B';
            const downloadText = downloadEl ? downloadEl.textContent : '0 B';
            
            // Parse values (approximate)
            const upload = parseTrafficValue(uploadText);
            const download = parseTrafficValue(downloadText);
            const total = upload + download || 1;
            
            // Clear
            ctx.clearRect(0, 0, width, height);
            
            // Draw bar chart
            const barHeight = 25;
            const gap = 10;
            
            // Upload bar
            ctx.fillStyle = 'rgba(34,197,94,0.2)';
            ctx.fillRect(0, 0, width, barHeight);
            ctx.fillStyle = '#22c55e';
            ctx.fillRect(0, 0, (upload / total) * width, barHeight);
            ctx.fillStyle = '#fff';
            ctx.font = '11px sans-serif';
            ctx.fillText('‚Üë ' + uploadText, 8, barHeight - 8);
            
            // Download bar
            ctx.fillStyle = 'rgba(59,130,246,0.2)';
            ctx.fillRect(0, barHeight + gap, width, barHeight);
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(0, barHeight + gap, (download / total) * width, barHeight);
            ctx.fillStyle = '#fff';
            ctx.fillText('‚Üì ' + downloadText, 8, barHeight + gap + barHeight - 8);
        }
        
        function formatSpeed(bytesPerSec) {
            if (bytesPerSec < 1024) return bytesPerSec.toFixed(0) + ' B/s';
            if (bytesPerSec < 1024 * 1024) return (bytesPerSec / 1024).toFixed(1) + ' KB/s';
            return (bytesPerSec / (1024 * 1024)).toFixed(2) + ' MB/s';
        }
        
        function parseTrafficValue(str) {
            const num = parseFloat(str) || 0;
            if (str.includes('GB')) return num * 1024 * 1024 * 1024;
            if (str.includes('MB')) return num * 1024 * 1024;
            if (str.includes('KB')) return num * 1024;
            return num;
        }

        async function resetStats() {
            const confirmed = await showConfirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?', '–°–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            if (!confirmed) return;
            
            try {
                const result = await go.main.App.ResetTrafficStats();
                if (result.success) {
                    showToast('success', '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
                    await updateStats();
                }
            } catch (e) {
                showToast('error', '–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        // ==================== Logs Modal ====================
        async function openLogsModal() {
            await updateLogsModal();
            document.getElementById('logsModal').classList.add('active');
        }

        async function updateLogsModal() {
            try {
                const result = await go.main.App.GetLogs(100);
                const container = document.getElementById('logsContainer');
                
                if (result.success && result.logs && result.logs.length > 0) {
                    container.innerHTML = result.logs.map(log => {
                        let className = 'log-entry';
                        if (log.toLowerCase().includes('error') || log.toLowerCase().includes('–æ—à–∏–±–∫–∞')) {
                            className += ' error';
                        } else if (log.toLowerCase().includes('success') || log.toLowerCase().includes('–∑–∞–ø—É—â–µ–Ω')) {
                            className += ' success';
                        }
                        return `<div class="${className}">${escapeHtml(log)}</div>`;
                    }).join('');
                    container.scrollTop = container.scrollHeight;
                } else {
                    container.innerHTML = '<div class="logs-empty">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
                }
            } catch (e) {
                console.error('Error loading logs:', e);
            }
        }

        async function clearLogs() {
            try {
                await go.main.App.ClearLogs();
                await updateLogsModal();
                showToast('success', '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
            } catch (e) {
                showToast('error', '–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== Updates ====================
        async function checkForUpdates() {
            try {
                const result = await go.main.App.CheckForUpdates();
                if (result.success && result.hasUpdate) {
                    updateInfo = result;
                    showUpdateBanner(result.latestVersion);
                }
            } catch (e) {
                console.error('Error checking for updates:', e);
            }
        }

        function showUpdateBanner(version) {
            document.getElementById('updateVersion').textContent = 'v' + version;
            document.getElementById('updateBanner').classList.add('show');
        }

        function hideUpdateBanner() {
            document.getElementById('updateBanner').classList.remove('show');
        }

        function openUpdateLink() {
            if (updateInfo && updateInfo.releaseURL) {
                window.open(updateInfo.releaseURL, '_blank');
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function openUpdateModal() {
            if (!updateInfo) return;
            
            document.getElementById('updateCurrentVersion').textContent = 'v' + updateInfo.currentVersion;
            document.getElementById('updateNewVersion').textContent = 'v' + updateInfo.latestVersion;
            document.getElementById('updateFileSize').textContent = updateInfo.fileSize ? formatFileSize(updateInfo.fileSize) : '-';
            document.getElementById('updatePublishedAt').textContent = updateInfo.publishedAt || '-';
            
            const notes = document.getElementById('updateNotes');
            if (updateInfo.releaseNotes) {
                notes.textContent = updateInfo.releaseNotes;
                notes.style.display = 'block';
            } else {
                notes.style.display = 'none';
            }
            
            document.getElementById('updateProgress').style.display = 'none';
            document.getElementById('updateModalStatus').className = 'modal-status';
            document.getElementById('updateModalStatus').textContent = '';
            document.getElementById('installUpdateBtn').disabled = false;
            
            hideUpdateBanner();
            openModal('updateModal');
        }

        async function installUpdate() {
            if (!updateInfo || !updateInfo.downloadURL) {
                showUpdateModalStatus('error', '–ù–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É');
                return;
            }
            
            // Disable button
            document.getElementById('installUpdateBtn').disabled = true;
            document.getElementById('updateProgress').style.display = 'block';
            showUpdateModalStatus('loading', '–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...');
            
            try {
                const result = await go.main.App.DownloadAndInstallUpdate(updateInfo.downloadURL);
                if (result.success) {
                    showUpdateModalStatus('success', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è...');
                } else {
                    showUpdateModalStatus('error', result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                    document.getElementById('installUpdateBtn').disabled = false;
                }
            } catch (e) {
                showUpdateModalStatus('error', '–û—à–∏–±–∫–∞: ' + e.message);
                document.getElementById('installUpdateBtn').disabled = false;
            }
        }

        function showUpdateModalStatus(type, message) {
            const status = document.getElementById('updateModalStatus');
            status.className = `modal-status ${type}`;
            status.textContent = message;
        }

        // Listen for update progress events
        if (window.runtime) {
            window.runtime.EventsOn('update-progress', (progress) => {
                const fill = document.getElementById('updateProgressFill');
                const text = document.getElementById('updateProgressText');
                if (fill) fill.style.width = progress.toFixed(0) + '%';
                if (text) text.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞: ' + progress.toFixed(0) + '%';
            });
        }

        // ==================== QR Scanner ====================
        let qrCameraStream = null;
        let qrScanInterval = null;

        function openQRScanner() {
            closeModal('vpnModal');
            document.getElementById('qrModalStatus').className = 'modal-status';
            document.getElementById('qrModalStatus').textContent = '';
            document.getElementById('qrCameraBtn').textContent = 'üì∑ –ö–∞–º–µ—Ä–∞';
            openModal('qrScannerModal');
        }

        function closeQRScanner() {
            stopQRCamera();
            closeModal('qrScannerModal');
        }

        async function toggleQRCamera() {
            if (qrCameraStream) {
                stopQRCamera();
            } else {
                await startQRCamera();
            }
        }

        async function startQRCamera() {
            try {
                const video = document.getElementById('qrVideo');
                qrCameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = qrCameraStream;
                video.play();
                
                document.getElementById('qrCameraBtn').textContent = '‚èπÔ∏è –°—Ç–æ–ø';
                showQRModalStatus('loading', '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥...');
                
                // Start scanning
                qrScanInterval = setInterval(() => scanQRFromVideo(), 500);
            } catch (e) {
                showQRModalStatus('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ: ' + e.message);
            }
        }

        function stopQRCamera() {
            if (qrCameraStream) {
                qrCameraStream.getTracks().forEach(track => track.stop());
                qrCameraStream = null;
            }
            if (qrScanInterval) {
                clearInterval(qrScanInterval);
                qrScanInterval = null;
            }
            const video = document.getElementById('qrVideo');
            video.srcObject = null;
            document.getElementById('qrCameraBtn').textContent = 'üì∑ –ö–∞–º–µ—Ä–∞';
        }

        function scanQRFromVideo() {
            const video = document.getElementById('qrVideo');
            const canvas = document.getElementById('qrCanvas');
            
            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = decodeQR(imageData);
            
            if (code) {
                handleQRResult(code);
            }
        }

        async function scanQRFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showQRModalStatus('loading', '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
            
            try {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('qrCanvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = decodeQR(imageData);
                    
                    if (code) {
                        handleQRResult(code);
                    } else {
                        showQRModalStatus('error', 'QR-–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏');
                    }
                };
                img.src = URL.createObjectURL(file);
            } catch (e) {
                showQRModalStatus('error', '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            }
            
            // Reset file input
            event.target.value = '';
        }

        function handleQRResult(code) {
            stopQRCamera();
            
            // Check if it looks like a subscription URL
            if (code.startsWith('http') || code.startsWith('vless://') || 
                code.startsWith('vmess://') || code.startsWith('trojan://') || 
                code.startsWith('ss://') || code.startsWith('ssr://')) {
                showQRModalStatus('success', 'QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω!');
                
                setTimeout(() => {
                    closeModal('qrScannerModal');
                    document.getElementById('subscriptionInput').value = code;
                    openVpnModal();
                }, 500);
            } else {
                showQRModalStatus('error', 'QR-–∫–æ–¥ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É');
            }
        }

        function showQRModalStatus(type, message) {
            const status = document.getElementById('qrModalStatus');
            status.className = `modal-status ${type}`;
            status.textContent = message;
        }

        // Simple QR decoder using jsQR-like algorithm
        // For production, use a proper library like jsQR
        function decodeQR(imageData) {
            // This is a placeholder - in production you'd use jsQR library
            // For now, we'll rely on camera scanning with a real library
            // or add jsQR CDN
            
            // Try to use jsQR if available
            if (typeof jsQR !== 'undefined') {
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                return code ? code.data : null;
            }
            
            // Fallback: can't decode without library
            return null;
        }

        // ==================== Paste and Context Menu ====================
        async function pasteToInput(inputId) {
            try {
                const text = await navigator.clipboard.readText();
                const input = document.getElementById(inputId);
                if (input && text) {
                    input.value = text;
                    input.focus();
                    // Trigger input event for any listeners
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    showToast('success', '–í—Å—Ç–∞–≤–ª–µ–Ω–æ –∏–∑ –±—É—Ñ–µ—Ä–∞');
                }
            } catch (err) {
                console.error('Failed to paste:', err);
                showToast('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞');
            }
        }
        
        // Context menu for right-click paste
        let contextMenu = null;
        let contextMenuTarget = null;
        
        function createContextMenu() {
            if (contextMenu) return;
            contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.innerHTML = `
                <div class="context-menu-item" onclick="contextMenuPaste()">
                    <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                    –í—Å—Ç–∞–≤–∏—Ç—å
                </div>
            `;
            document.body.appendChild(contextMenu);
        }
        
        function showContextMenu(e, target) {
            createContextMenu();
            contextMenuTarget = target;
            contextMenu.style.left = e.clientX + 'px';
            contextMenu.style.top = e.clientY + 'px';
            contextMenu.classList.add('active');
        }
        
        function hideContextMenu() {
            if (contextMenu) {
                contextMenu.classList.remove('active');
            }
            contextMenuTarget = null;
        }
        
        async function contextMenuPaste() {
            if (contextMenuTarget) {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        contextMenuTarget.value = text;
                        contextMenuTarget.focus();
                        contextMenuTarget.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                } catch (err) {
                    console.error('Failed to paste:', err);
                }
            }
            hideContextMenu();
        }
        
        // Add right-click handlers to inputs/textareas
        document.addEventListener('contextmenu', (e) => {
            const target = e.target;
            if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
                e.preventDefault();
                showContextMenu(e, target);
            }
        });
        
        // Hide context menu on click outside
        document.addEventListener('click', (e) => {
            if (contextMenu && !contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });
        
        // Hide context menu on scroll
        document.addEventListener('scroll', hideContextMenu, true);

        // ==================== Notifications / Toast ====================
        function showToast(type, message) {
            try {
                const container = document.getElementById('toastContainer');
                if (!container) {
                    console.error('Toast container not found');
                    return;
                }
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
                const isError = type === 'error' || type === 'warning';
                
                // Log errors to application logs (async, don't wait)
                if (isError && typeof go !== 'undefined' && go.main && go.main.App && go.main.App.AddToLogBuffer) {
                    const logLevel = type === 'error' ? 'ERROR' : 'WARNING';
                    go.main.App.AddToLogBuffer(`[${logLevel}] UI: ${message}`).catch(e => console.error('Log error:', e));
                }
                
                const toastId = 'toast-' + Date.now();
                toast.id = toastId;
                
                // Get translation safely
                const copyText = (typeof t === 'function' ? t('copy') : null) || '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                
                let actionsHtml = '';
                if (isError) {
                    actionsHtml = `
                        <div class="toast-actions">
                            <button class="toast-btn" onclick="copyToastMessage('${toastId}')">üìã ${copyText}</button>
                        </div>
                    `;
                }
                
                toast.innerHTML = `
                    <span class="icon">${icons[type] || '‚ÑπÔ∏è'}</span>
                    <div class="toast-content">
                        <span class="message">${message}</span>
                        ${actionsHtml}
                    </div>
                    <button class="toast-close" onclick="closeToast('${toastId}')">√ó</button>
                `;
                
                container.appendChild(toast);
                
                // Longer timeout for errors (8s) vs success (3s)
                const timeout = isError ? 8000 : 3000;
                
                setTimeout(() => {
                    if (document.getElementById(toastId)) {
                        toast.classList.add('hide');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, timeout);
            } catch (e) {
                console.error('showToast error:', e);
            }
        }
        
        function copyToastMessage(toastId) {
            try {
                const toast = document.getElementById(toastId);
                if (!toast) return;
                
                const messageEl = toast.querySelector('.message');
                if (!messageEl) return;
                
                const message = messageEl.textContent;
                const copiedText = (typeof t === 'function' ? t('copied') : null) || '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
                const copyText = (typeof t === 'function' ? t('copy') : null) || '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                
                navigator.clipboard.writeText(message).then(() => {
                    const btn = toast.querySelector('.toast-btn');
                    if (btn) {
                        btn.classList.add('copied');
                        btn.textContent = '‚úì ' + copiedText;
                        setTimeout(() => {
                            btn.classList.remove('copied');
                            btn.textContent = 'üìã ' + copyText;
                        }, 2000);
                    }
                }).catch(e => console.error('Copy error:', e));
            } catch (e) {
                console.error('copyToastMessage error:', e);
            }
        }
        
        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }
        }

        function showNotification(title, body) {
            // Check if notifications are enabled
            if (!appConfig?.notifications) return;
            
            // Use toast as fallback
            showToast('info', body);
        }

        // Common functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Stop stats update interval when closing stats modal
            if (modalId === 'statsModal' && statsUpdateInterval) {
                clearInterval(statsUpdateInterval);
                statsUpdateInterval = null;
            }
        }

        function closeModalOnOverlay(event, modalId) {
            if (event.target.id === modalId) closeModal(modalId);
        }

        function truncateUrl(url) {
            if (url.length > 50) return url.substring(0, 25) + '...' + url.substring(url.length - 20);
            return url;
        }

        async function openFolder() { try { await go.main.App.OpenConfigFolder(); } catch (e) {} }
        async function openLogs() { try { await go.main.App.OpenLogs(); } catch (e) {} }
        
        // Helper to open modal
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Keyboard handlers
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal('vpnModal');
                closeModal('wgListModal');
                closeWgEditModal();
                closeModal('aboutModal');
                closeModal('settingsModal');
                closeModal('statsModal');
                closeModal('logsModal');
                closeModal('profilesModal');
                closeModal('profileEditModal');
                closeQRScanner();
                closeModal('updateModal');
            }
        });

        // Window visibility tracking
        document.addEventListener('visibilitychange', () => {
            const visible = !document.hidden;
            try {
                go.main.App.SetWindowVisible(visible);
            } catch (e) {}
        });

        // Events from backend
        if (window.runtime) {
            window.runtime.EventsOn('vpn-status-changed', (running) => {
                updateStatus();
                // Show notification
                if (appConfig?.notifications) {
                    if (running) {
                        showToast('success', 'VPN –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    } else {
                        showToast('info', 'VPN –æ—Ç–∫–ª—é—á–µ–Ω');
                    }
                }
            });
            window.runtime.EventsOn('show-about', () => openAbout());
        }

        // Load app config on init
        async function loadAppConfig() {
            try {
                const config = await go.main.App.GetAppConfig();
                if (config.success) {
                    appConfig = config;
                    // Apply theme
                    if (config.theme) {
                        applyTheme(config.theme);
                    }
                    // Apply language
                    if (config.language) {
                        applyLanguage(config.language);
                    }
                    // Check for updates if enabled
                    if (config.checkUpdates) {
                        setTimeout(checkForUpdates, 2000);
                    }
                }
            } catch (e) {
                console.error('Error loading app config:', e);
            }
        }

        // ==================== Profile Functions ====================
        
        async function loadProfiles() {
            try {
                const result = await go.main.App.GetProfiles();
                if (result.success) {
                    currentProfiles = result.profiles || [];
                    activeProfileId = result.activeProfile || 1;
                    updateActiveProfileDisplay();
                }
            } catch (e) {
                console.error('Error loading profiles:', e);
            }
        }
        
        function updateActiveProfileDisplay() {
            const profile = currentProfiles.find(p => p.id === activeProfileId);
            const subtitle = document.getElementById('activeProfileName');
            if (profile && subtitle) {
                subtitle.textContent = `–ü—Ä–æ—Ñ–∏–ª—å: ${profile.name}`;
            }
        }
        
        function openProfilesModal() {
            // Don't allow opening profiles modal while VPN is connected
            if (isVpnRunning) {
                showToast('warning', '–û—Ç–∫–ª—é—á–∏—Ç–µ VPN –¥–ª—è —Å–º–µ–Ω—ã –ø—Ä–æ—Ñ–∏–ª—è');
                return;
            }
            loadProfiles().then(() => {
                renderProfilesList();
                openModal('profilesModal');
            });
        }
        
        function renderProfilesList() {
            const container = document.getElementById('profilesList');
            if (!container) return;
            
            if (currentProfiles.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π</div>';
                return;
            }
            
            container.innerHTML = currentProfiles.map(profile => `
                <div class="profile-item ${profile.id === activeProfileId ? 'active' : ''}" 
                     onclick="selectProfile(${profile.id})">
                    ${profile.id === activeProfileId ? '<div class="active-indicator"></div>' : ''}
                    <div class="profile-info">
                        <div class="profile-name">
                            ${escapeHtml(profile.name)}
                            ${profile.id === 1 ? '<span class="default-badge">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>' : ''}
                        </div>
                        <div class="profile-meta">
                            ${profile.subscription ? `<span>‚ö° ${profile.proxyCount || 0} –ø—Ä–æ–∫—Å–∏</span>` : '<span>‚ö° –ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏</span>'}
                            ${profile.wireguards && profile.wireguards.length ? `<span>üè¢ ${profile.wireguards.length} WG</span>` : ''}
                        </div>
                    </div>
                    <div class="profile-actions" onclick="event.stopPropagation()">
                        <button class="edit-btn" onclick="openEditProfileModal(${profile.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteProfile(${profile.id})" 
                                ${profile.id === 1 ? 'disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"' : 'title="–£–¥–∞–ª–∏—Ç—å"'}>üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function selectProfile(id) {
            if (id === activeProfileId) return;
            
            // Don't allow switching while connected
            if (isVpnRunning) {
                showToast('warning', '–û—Ç–∫–ª—é—á–∏—Ç–µ VPN –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π –ø—Ä–æ—Ñ–∏–ª—è');
                return;
            }
            
            try {
                const result = await go.main.App.SetActiveProfile(id);
                if (result.success) {
                    activeProfileId = id;
                    renderProfilesList();
                    updateActiveProfileDisplay();
                    showToast('success', '–ü—Ä–æ—Ñ–∏–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                    // Reload subscriptions and WireGuard for new profile
                    updateSubscriptionBadge();
                    updateWireGuardBadge();
                } else {
                    showToast('error', result.error || '–û—à–∏–±–∫–∞');
                }
            } catch (e) {
                showToast('error', '–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø—Ä–æ—Ñ–∏–ª—è');
            }
        }
        
        function openCreateProfileModal() {
            editingProfileId = null;
            document.getElementById('profileEditTitle').textContent = '‚ûï –ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å';
            document.getElementById('profileNameInput').value = '';
            document.getElementById('saveProfileBtn').textContent = '–°–æ–∑–¥–∞—Ç—å';
            document.getElementById('profileModalStatus').className = 'modal-status';
            document.getElementById('profileModalStatus').textContent = '';
            closeModal('profilesModal');
            openModal('profileEditModal');
            document.getElementById('profileNameInput').focus();
        }
        
        function openEditProfileModal(id) {
            const profile = currentProfiles.find(p => p.id === id);
            if (!profile) return;
            
            editingProfileId = id;
            document.getElementById('profileEditTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
            document.getElementById('profileNameInput').value = profile.name;
            document.getElementById('saveProfileBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            document.getElementById('profileModalStatus').className = 'modal-status';
            document.getElementById('profileModalStatus').textContent = '';
            closeModal('profilesModal');
            openModal('profileEditModal');
            document.getElementById('profileNameInput').focus();
        }
        
        async function saveProfile() {
            const name = document.getElementById('profileNameInput').value.trim();
            const status = document.getElementById('profileModalStatus');
            
            if (!name) {
                status.className = 'modal-status error';
                status.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è';
                return;
            }
            
            try {
                let result;
                if (editingProfileId === null) {
                    result = await go.main.App.CreateProfile(name);
                } else {
                    result = await go.main.App.UpdateProfile(editingProfileId, name);
                }
                
                if (result.success) {
                    closeModal('profileEditModal');
                    await loadProfiles();
                    showToast('success', editingProfileId ? '–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω' : '–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω');
                    openModal('profilesModal');
                    renderProfilesList();
                } else {
                    status.className = 'modal-status error';
                    status.textContent = result.error || '–û—à–∏–±–∫–∞';
                }
            } catch (e) {
                status.className = 'modal-status error';
                status.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            }
        }
        
        async function deleteProfile(id) {
            if (id === 1) {
                showToast('warning', '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                return;
            }
            
            const profile = currentProfiles.find(p => p.id === id);
            if (!profile) return;
            
            const confirmed = await showConfirm(
                `–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å "${profile.name}"? –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.`,
                '–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è'
            );
            
            if (!confirmed) return;
            
            try {
                const result = await go.main.App.DeleteProfile(id);
                if (result.success) {
                    await loadProfiles();
                    renderProfilesList();
                    showToast('success', '–ü—Ä–æ—Ñ–∏–ª—å —É–¥–∞–ª—ë–Ω');
                } else {
                    showToast('error', result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (e) {
                showToast('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
            }
        }
        
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Load and display version badge
        async function loadFooterVersion() {
            try {
                const result = await go.main.App.GetAppVersion();
                if (result.success) {
                    const versionEl = document.getElementById('versionBadge');
                    if (versionEl) {
                        versionEl.textContent = 'v' + result.fullVersion;
                        versionEl.title = `Build: ${result.buildTime}\nClick to copy`;
                        versionEl.onclick = () => {
                            navigator.clipboard.writeText(result.fullVersion);
                            showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', 'success');
                        };
                    }
                }
            } catch (e) {
                console.error('Failed to load version:', e);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus();
            updateSubscriptionBadge();
            updateWireGuardBadge();
            loadAppConfig();
            loadProfiles();
            loadFooterVersion();
            setInterval(updateStatus, 3000);
        });

        if (document.readyState !== 'loading') {
            updateStatus();
            updateSubscriptionBadge();
            updateWireGuardBadge();
            loadAppConfig();
            loadProfiles();
            loadFooterVersion();
        }
    </script>
</body>
</html>
